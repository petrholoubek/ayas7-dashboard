<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>SPF – Provizní fond družstva WIN.WIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="./assets/js/gate.js"></script>

<style>
:root{
  --bg:#020617;
  --card:#0b1120;
  --border:rgba(148,163,184,.25);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --gold:#facc15;
  --green:#22c55e;
  --red:#ef4444;
}
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
  background:radial-gradient(circle at 40% 0%, #0f172a 0%, #020617 65%, #000 100%);
  color:var(--text);
}
.page{max-width:1400px;margin:auto;padding:42px 18px 80px}
.card{
  background:radial-gradient(circle at top left,#0b1120,#020617 70%);
  border:1px solid var(--border);
  border-radius:20px;
  padding:24px;
  margin-bottom:26px;
}
h1{font-size:30px;margin-bottom:10px}
h2{font-size:18px;margin-bottom:10px}
p{font-size:13px;line-height:1.6;color:var(--muted)}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:10px;border-bottom:1px solid var(--border)}
th{color:var(--muted);text-align:left}

.kicker{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:#9ca3af;
  margin-bottom:10px;
}

.led{
  width:9px;
  height:9px;
  border-radius:999px;
}

/* BARVY PODLE TÉMAT */
.led-yellow{
  background:#facc15;
  box-shadow:0 0 8px rgba(250,204,21,.9);
}

.led-blue{
  background:#38bdf8;
  box-shadow:0 0 8px rgba(56,189,248,.9);
}

.led-red{
  background:#ef4444;
  box-shadow:0 0 8px rgba(239,68,68,.9);
}

.led-green{
  background:#22c55e;
  box-shadow:0 0 8px rgba(34,197,94,.9);
}


</style>
</head>
<body>

<div class="page">

<div class="card">
  <div class="kicker">
    <span class="led led-yellow"></span>
    Interní rozhodovací vrstva SPF
  </div>

  <h1>SPF – Síťový provizní fond družstva WIN.WIN</h1>
  <p>
    Tato stránka slouží k <b>internímu rozhodování, evidenci a auditu</b>
    rozdělení prostředků SPF a matching bonusů.
    <br><br>
    <b>Nejedná se o nárokový systém</b> a žádná zde zobrazená hodnota
    nezakládá automatické právo na výplatu či plnění.
  </p>
</div>

<div class="card">
  <div class="kicker">
    <span class="led led-blue"></span>
    Kariérní klasifikace a výkonnost
  </div>

  <h2>Kariérní statusy a koeficienty CRX</h2>
  <p>
    Přehled kariérních úrovní dle <b>Přílohy č. 1 k Proviznímu řádu</b>.
    Koeficient CRX je aplikován automaticky dle splnění podmínek.
  </p>

  <table>
    <thead>
      <tr>
        <th>Status</th>
        <th>Rozsah WW-KEY</th>
        <th>Koeficient CRX / měsíc</th>
        <th>Počet členů</th>
        <th>Celkem CRX</th>
      </tr>
    </thead>
    <tbody id="career-status-table">
      <tr><td colspan="5">Načítám data…</td></tr>
    </tbody>
  </table>
</div>

<div class="card">
  <div class="kicker">
    <span class="led led-yellow"></span>
    Rozhodnutí orgánu družstva
  </div>

  <h2>Rozhodnutí SPF za období</h2>
  <p>
    Tato část slouží k formálnímu schválení nebo zamítnutí
    návrhu rozdělení prostředků SPF.
  </p>

  <table>
    <thead>
      <tr>
        <th>Období</th>
        <th>Návrh CRX</th>
        <th>Stav</th>
        <th>Akce</th>
      </tr>
    </thead>
    <tbody id="spf-periods">
      <tr><td colspan="4">Načítám období…</td></tr>
    </tbody>
  </table>
</div>

<div class="card">
  <div class="kicker">
    <span class="led led-red"></span>
    Auditní uzávěrka období
  </div>

  <h2>Uzávěrka období</h2>
  <p>
    Formální uzavření období bez rozdělení prostředků.
    Tento krok je <b>auditní a nevratný</b>.
  </p>

  <div id="audit-info">
    Uzavřeno: — <br>
    Audit hash: — zatím nevygenerován
  </div>

  <button style="margin-top:12px;color:#ef4444;border:1px solid #ef4444;background:none"
    onclick="closePeriod()">
    Uzavřít období
  </button>
</div>

<div class="card" style="border-color:#22c55e">
  <div class="kicker">
    <span class="led led-green"></span>
    Provozní řízení benefitů
  </div>

  <h2>Řízení dostupnosti členských benefitů</h2>
  <p>
    Tato část slouží k <b>provoznímu řízení dostupnosti benefitů</b>.
    <br>
    <b>Nejde o výpočet, přidělování ani nárokový systém.</b>
    Změny jsou auditně dohledatelné.
  </p>

  <table>
    <thead>
      <tr>
        <th>Název</th>
        <th>Kód</th>
        <th>CRX</th>
        <th>Stav</th>
        <th>Akce</th>
      </tr>
    </thead>
    <tbody id="benefitStatusTable">
      <tr><td colspan="5">Načítám benefity…</td></tr>
    </tbody>
  </table>
</div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* =========================================================
   SUPABASE – JEDINÁ INSTANCE PRO SPF
   ========================================================= */
const supabase = createClient(
  "https://azfrniqqtetoqploxwgq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU"
);

window.supabase = supabase;

/* =========================================================
   KARIÉRNÍ STATUSY – READ ONLY (DB → UI)
   Zdroj: v_spf_career_status_summary
   ========================================================= */
async function loadCareerStatuses() {

  const tbody = document.getElementById("career-status-table");
  if (!tbody) return;

  tbody.innerHTML = `
    <tr>
      <td colspan="5" style="color:#9ca3af">
        Načítám data z databáze…
      </td>
    </tr>
  `;

 const { data, error } = await supabase
  .from("v_spf_career_summary")
  .select(`
    status,
    wwkey_min,
    wwkey_max,
    crx_coef_min,
    crx_coef_max,
    member_count,
    crx_total_min
  `)
  .order("wwkey_min");


  if (error) {
    console.error("❌ Chyba načtení kariérních statusů:", error);
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="color:#ef4444">
          Chyba načtení dat z DB
        </td>
      </tr>
    `;
    return;
  }

  if (!data || !data.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="color:#9ca3af">
          Žádná data k zobrazení
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = "";

  data.forEach(row => {

    const wwkeyRange = row.wwkey_max
      ? `${row.wwkey_min.toLocaleString("cs-CZ")} – ${row.wwkey_max.toLocaleString("cs-CZ")}`
      : `${row.wwkey_min.toLocaleString("cs-CZ")}+`;

    const coefRange = `${row.crx_coef_min} – ${row.crx_coef_max}`;

    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td><strong>${row.status}</strong></td>
        <td>${wwkeyRange}</td>
        <td>${coefRange}</td>
        <td>${row.member_count}</td>
        <td>${Number(row.crx_total_min).toLocaleString("cs-CZ")}</td>
      </tr>
    `);
  });
}

/* =========================================================
   INIT
   ========================================================= */
document.addEventListener("DOMContentLoaded", () => {
  loadCareerStatuses();
});
</script>



</body>
</html>
