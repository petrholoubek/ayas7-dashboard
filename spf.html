<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>SPF ‚Äì Provizn√≠ fond dru≈æstva WIN.WIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="./assets/js/gate.js"></script>

<style>
:root{
  --bg:#020617;
  --card:#0b1120;
  --border:rgba(148,163,184,.25);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --gold:#facc15;
  --green:#22c55e;
  --red:#ef4444;
}
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
  background:radial-gradient(circle at 40% 0%, #0f172a 0%, #020617 65%, #000 100%);
  color:var(--text);
}
.page{max-width:1400px;margin:auto;padding:42px 18px 80px}
.card{
  background:radial-gradient(circle at top left,#0b1120,#020617 70%);
  border:1px solid var(--border);
  border-radius:20px;
  padding:24px;
  margin-bottom:26px;
}
h1{font-size:30px;margin-bottom:10px}
h2{font-size:18px;margin-bottom:10px}
p{font-size:13px;line-height:1.6;color:var(--muted)}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:10px;border-bottom:1px solid var(--border)}
th{color:var(--muted);text-align:left}

.kicker{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:#9ca3af;
  margin-bottom:10px;
}

.led{
  width:9px;
  height:9px;
  border-radius:999px;
}

/* BARVY PODLE T√âMAT */
.led-yellow{
  background:#facc15;
  box-shadow:0 0 8px rgba(250,204,21,.9);
}

.led-blue{
  background:#38bdf8;
  box-shadow:0 0 8px rgba(56,189,248,.9);
}

.led-red{
  background:#ef4444;
  box-shadow:0 0 8px rgba(239,68,68,.9);
}

.led-green{
  background:#22c55e;
  box-shadow:0 0 8px rgba(34,197,94,.9);
}


</style>
</head>
<body>

<div class="page">

<div class="card">
  <div class="kicker">
    <span class="led led-yellow"></span>
    Intern√≠ rozhodovac√≠ vrstva SPF
  </div>

  <h1>SPF ‚Äì S√≠≈•ov√Ω provizn√≠ fond dru≈æstva WIN.WIN</h1>
  <p>
    Tato str√°nka slou≈æ√≠ k <b>intern√≠mu rozhodov√°n√≠, evidenci a auditu</b>
    rozdƒõlen√≠ prost≈ôedk≈Ø SPF a matching bonus≈Ø.
    <br><br>
    <b>Nejedn√° se o n√°rokov√Ω syst√©m</b> a ≈æ√°dn√° zde zobrazen√° hodnota
    nezakl√°d√° automatick√© pr√°vo na v√Ωplatu ƒçi plnƒõn√≠.
  </p>
</div>

<div class="card">
  <div class="kicker">
    <span class="led led-blue"></span>
    Kari√©rn√≠ klasifikace a v√Ωkonnost
  </div>

  <h2>Kari√©rn√≠ statusy a koeficienty CRX</h2>
  <p>
    P≈ôehled kari√©rn√≠ch √∫rovn√≠ dle <b>P≈ô√≠lohy ƒç. 1 k Provizn√≠mu ≈ô√°du</b>.
    Koeficient CRX je aplikov√°n automaticky dle splnƒõn√≠ podm√≠nek.
  </p>

  <table>
    <thead>
      <tr>
        <th>Status</th>
        <th>Rozsah WW-KEY</th>
        <th>Koeficient CRX / mƒõs√≠c</th>
        <th>Poƒçet ƒçlen≈Ø</th>
        <th>Celkem CRX</th>
      </tr>
    </thead>
    <tbody id="career-status-table">
      <tr><td colspan="5">Naƒç√≠t√°m data‚Ä¶</td></tr>
    </tbody>
  </table>
</div>

<div class="card">
  <div class="kicker">
    <span class="led led-yellow"></span>
    Rozhodnut√≠ org√°nu dru≈æstva
  </div>

  <h2>Rozhodnut√≠ SPF za obdob√≠</h2>
  <p>
    Tato ƒç√°st slou≈æ√≠ k form√°ln√≠mu schv√°len√≠ nebo zam√≠tnut√≠
    n√°vrhu rozdƒõlen√≠ prost≈ôedk≈Ø SPF.
  </p>

  <table>
    <thead>
      <tr>
        <th>Obdob√≠</th>
        <th>N√°vrh CRX</th>
        <th>Stav</th>
        <th>Akce</th>
      </tr>
    </thead>
    <tbody id="spf-periods">
      <tr><td colspan="4">Naƒç√≠t√°m obdob√≠‚Ä¶</td></tr>
    </tbody>
  </table>
</div>

<div class="card">
  <div class="kicker">
    <span class="led led-red"></span>
    Auditn√≠ uz√°vƒõrka obdob√≠
  </div>

  <h2>Uz√°vƒõrka obdob√≠</h2>
  <p>
    Form√°ln√≠ uzav≈ôen√≠ obdob√≠ bez rozdƒõlen√≠ prost≈ôedk≈Ø.
    Tento krok je <b>auditn√≠ a nevratn√Ω</b>.
  </p>

  <div id="audit-info">
    Uzav≈ôeno: ‚Äî <br>
    Audit hash: ‚Äî zat√≠m nevygenerov√°n
  </div>

  <button style="margin-top:12px;color:#ef4444;border:1px solid #ef4444;background:none"
    onclick="closePeriod()">
    Uzav≈ô√≠t obdob√≠
  </button>
</div>

<div class="card" style="border-color:#22c55e">
  <div class="kicker">
    <span class="led led-green"></span>
    Provozn√≠ ≈ô√≠zen√≠ benefit≈Ø
  </div>

  <h2>≈ò√≠zen√≠ dostupnosti ƒçlensk√Ωch benefit≈Ø</h2>
  <p>
    Tato ƒç√°st slou≈æ√≠ k <b>provozn√≠mu ≈ô√≠zen√≠ dostupnosti benefit≈Ø</b>.
    <br>
    <b>Nejde o v√Ωpoƒçet, p≈ôidƒõlov√°n√≠ ani n√°rokov√Ω syst√©m.</b>
    Zmƒõny jsou auditnƒõ dohledateln√©.
  </p>

  <table>
    <thead>
      <tr>
        <th>N√°zev</th>
        <th>K√≥d</th>
        <th>CRX</th>
        <th>Stav</th>
        <th>Akce</th>
      </tr>
    </thead>
    <tbody id="benefitStatusTable">
      <tr><td colspan="5">Naƒç√≠t√°m benefity‚Ä¶</td></tr>
    </tbody>
  </table>
</div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* =========================================================
   SUPABASE ‚Äì JEDIN√Å INSTANCE PRO SPF
   ========================================================= */
const supabase = createClient(
  "https://azfrniqqtetoqploxwgq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU"
);

window.supabase = supabase;

/* =========================================================
   KARI√âRN√ç STATUSY ‚Äì READ ONLY (DB ‚Üí UI)
   Zdroj: v_spf_career_summary
   ========================================================= */
async function loadCareerStatuses() {

  const tbody = document.getElementById("career-status-table");
  if (!tbody) return;

  tbody.innerHTML = `
    <tr>
      <td colspan="5" style="color:#9ca3af">
        Naƒç√≠t√°m data z datab√°ze‚Ä¶
      </td>
    </tr>
  `;

  const { data, error } = await supabase
    .from("v_spf_career_summary")
    .select(`
      status,
      wwkey_min,
      wwkey_max,
      crx_coef_min,
      crx_coef_max,
      member_count,
      crx_total_min
    `)
    .order("wwkey_min");

  if (error) {
    console.error("‚ùå Chyba naƒçten√≠ kari√©rn√≠ch status≈Ø:", error);
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="color:#ef4444">
          Chyba naƒçten√≠ dat z DB
        </td>
      </tr>
    `;
    return;
  }

  if (!data || !data.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="color:#9ca3af">
          ≈Ω√°dn√° data k zobrazen√≠
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = "";

  data.forEach(row => {

    const wwkeyRange = row.wwkey_max
      ? `${row.wwkey_min.toLocaleString("cs-CZ")} ‚Äì ${row.wwkey_max.toLocaleString("cs-CZ")}`
      : `${row.wwkey_min.toLocaleString("cs-CZ")}+`;

    const coefRange = `${row.crx_coef_min} ‚Äì ${row.crx_coef_max}`;

    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td><strong>${row.status}</strong></td>
        <td>${wwkeyRange}</td>
        <td>${coefRange}</td>
        <td>${row.member_count}</td>
        <td>${Number(row.crx_total_min).toLocaleString("cs-CZ")}</td>
      </tr>
    `);
  });
}

/* =========================================================
   AUDITN√ç UZ√ÅVƒöRKA OBDOB√ç (NEVRATN√Å)
   ========================================================= */
window.closePeriod = async function () {

  if (!window.selectedPeriod) {
    alert("Nen√≠ vybr√°no ≈æ√°dn√© obdob√≠.");
    return;
  }

  if (!confirm(
    "Uzav≈ôen√≠ obdob√≠ je auditn√≠ a nevratn√©.\n\nPokraƒçovat?"
  )) return;

  const { data, error } = await supabase
    .rpc("close_spf_period", {
      p_period: window.selectedPeriod
    });

  if (error) {
    console.error("‚ùå Uz√°vƒõrka obdob√≠ selhala:", error);
    alert("Chyba p≈ôi uzav√≠r√°n√≠ obdob√≠.");
    return;
  }

  if (!data || !data.length) {
    alert("Uz√°vƒõrka nevr√°tila ≈æ√°dn√° data.");
    return;
  }

  const row = data[0];

  document.getElementById("audit-info").innerHTML = `
    Uzav≈ôeno: ${new Date(row.closed_at).toLocaleString("cs-CZ")}<br>
    Audit hash: ${row.audit_hash}
  `;

  alert("Obdob√≠ bylo auditnƒõ uzav≈ôeno.");

  if (typeof loadSPFPeriods === "function") {
    loadSPFPeriods();
  }
};



/* =========================================================
   INIT ‚Äì POUZE TO, CO EXISTUJE
   ========================================================= */
document.addEventListener("DOMContentLoaded", () => {
  loadCareerStatuses();
});
</script>

<script type="module">
/* =========================================================
   BENEFITY ‚Äì PROVOZN√ç MODUL (NE SPF)
   ========================================================= */

const supabase = window.supabase;
if (!supabase) {
  console.error("‚ùå Supabase nen√≠ dostupn√° pro benefit modul");
}

/* =========================
   NAƒåTEN√ç BENEFIT≈Æ
========================= */
async function loadBenefitStates() {
  const tbody = document.getElementById("benefitStatusTable");
  if (!tbody) return;

  tbody.innerHTML = `
    <tr>
      <td colspan="5" style="color:#9ca3af">
        Naƒç√≠t√°m benefity‚Ä¶
      </td>
    </tr>
  `;

  const { data, error } = await supabase
    .from("benefits")
    .select("id, name, code, crx_cost, is_active")
    .order("name");

  if (error) {
    console.error("‚ùå Chyba naƒçten√≠ benefit≈Ø:", error);
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="color:#ef4444">
          Chyba naƒçten√≠ benefit≈Ø
        </td>
      </tr>
    `;
    return;
  }

  if (!data || !data.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="color:#9ca3af">
          ≈Ω√°dn√© benefity
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = "";

  data.forEach(b => {
    const statusLabel = b.is_active
      ? `<span style="color:#22c55e">üü¢ aktivn√≠</span>`
      : `<span style="color:#facc15">üü° p≈ôipravuje se</span>`;

    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${b.name}</td>
        <td><code>${b.code}</code></td>
        <td>${b.crx_cost ?? "‚Äî"}</td>
        <td>${statusLabel}</td>
        <td>
          <select onchange="updateBenefitStatus('${b.id}', this.value)">
            <option value="">‚Äî zmƒõnit ‚Äî</option>
            <option value="true">Aktivn√≠</option>
            <option value="false">P≈ôipravuje se</option>
          </select>
        </td>
      </tr>
    `);
  });
}

/* =========================
   ZMƒöNA STAVU BENEFITU
========================= */
window.updateBenefitStatus = async (id, value) => {
  if (!value) return;

  const isActive = value === "true";

  if (!confirm("Zmƒõnit dostupnost benefitu?")) return;

  const { error } = await supabase
    .from("benefits")
    .update({ is_active: isActive })
    .eq("id", id);

  if (error) {
    alert("Chyba p≈ôi zmƒõnƒõ benefitu");
    console.error(error);
    return;
  }

  loadBenefitStates();
};

/* =========================
   INIT BENEFIT MODULU
========================= */
document.addEventListener("DOMContentLoaded", () => {
  loadBenefitStates();
});
</script>



</body>
</html>
