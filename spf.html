<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>SPF – Síťový provozní fond · WIN.WIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- FAVICON / PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/ayas7-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/ayas7-512.png">
  <link rel="apple-touch-icon" href="/ayas7-192.png">
  <meta name="theme-color" content="#020617">
<style>
:root{
  --bg:#020617;
  --card:#0b1120;
  --border:rgba(148,163,184,.25);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --gold:#facc15;
  --green:#22c55e;
  --red:#ef4444;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  background:radial-gradient(circle at 40% 0%, #0f172a 0%, #020617 65%, #000 100%);
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
  color:var(--text);
}

.page{max-width:1400px;margin:auto;padding:42px 18px 80px}

.card{
  background:radial-gradient(circle at top left,#0b1120,#020617 70%);
  border:1px solid var(--border);
  border-radius:20px;
  padding:22px;
  margin-bottom:26px;
}

.kicker{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:6px;
}

.dot{
  width:9px;height:9px;border-radius:999px;
  background:var(--gold);
  box-shadow:
    0 0 6px var(--gold),
    0 0 16px var(--gold),
    0 0 36px rgba(250,204,21,.9);
}

h1{font-size:30px;margin-bottom:10px}
h2{font-size:18px;margin-bottom:10px}
p{font-size:13px;line-height:1.6;color:var(--muted)}

table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  table-layout:fixed;
}

/* === SPF TABULKA – TVRDÉ ZAROVNÁNÍ SLOUPCŮ === */
table{
  table-layout: fixed;
}

thead th,
tbody td{
  padding:10px;
  vertical-align:middle;
}

/* Období */
thead th:nth-child(1),
tbody td:nth-child(1){
  width:120px;
}

/* Celkový příděl CRX */
thead th:nth-child(2),
tbody td:nth-child(2){
  width:180px;
  text-align:right;
}

/* Návrh do SPF */
thead th:nth-child(3),
tbody td:nth-child(3){
  width:160px;
  text-align:right;
}

/* Stav */
thead th:nth-child(4),
tbody td:nth-child(4){
  width:120px;
}

/* Akce */
thead th:nth-child(5),
tbody td:nth-child(5){
  width:240px;
}


th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
}
/* === TVRDÉ ZAROVNÁNÍ TEXTU V HLAVIČCE I DATECH === */
thead th{
  text-align:left;
}

tbody td{
  text-align:left;
}
/* Období – HLAVIČKA I DATA NA STEJNOU POZICI */
thead th:nth-child(1),
tbody td:nth-child(1){
  padding-left:10px;
  text-align:left;
}


th{color:var(--muted)}

/* PEVNÉ SLOUPCE – DŮLEŽITÉ */
th:nth-child(1), td:nth-child(1){ width:120px; }
th:nth-child(2), td:nth-child(2){ width:180px; text-align:right; }
th:nth-child(3), td:nth-child(3){ width:160px; text-align:right; }
th:nth-child(4), td:nth-child(4){ width:120px; }
th:nth-child(5), td:nth-child(5){ width:220px; }

/* TLAČÍTKA */
.actions{
  display:flex;
  gap:14px;
}


button{
  padding:6px 12px;
  border-radius:10px;
  font-size:11px;
  cursor:pointer;
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
}
.approve{border-color:var(--green);color:var(--green)}
.reject{border-color:var(--red);color:var(--red)}

.dot-gold{
  background:#facc15;
  box-shadow:
    0 0 6px rgba(250,204,21,.9),
    0 0 14px rgba(250,204,21,.8),
    0 0 30px rgba(250,204,21,.6);
}
.cell-actions{
  display:flex;
  align-items:center;
  gap:12px;
  min-height:28px;
}
/* === FIX ZAROVNÁNÍ SPF TABULKY === */
table thead th,
table tbody td{
  vertical-align: middle;
}

/* ČÍSLA VPRAVO – HLAVIČKA I DATA */
table th:nth-child(2),
table th:nth-child(3),
table td:nth-child(2),
table td:nth-child(3){
  text-align: right;
}

/* STAV */
table th:nth-child(4),
table td:nth-child(4){
  text-align: left;
  white-space: nowrap;
}

/* AKCE – PEVNÝ BLOK */
table th:nth-child(5),
table td:nth-child(5){
  text-align: left;
  white-space: nowrap;
}

</style>
</head>

<body>
<div id="user-bar" style="
  position:fixed;
  top:12px;
  right:16px;
  z-index:9999;
  font-size:12px;
  color:#e5e7eb;
  background:rgba(2,6,23,0.85);
  border:1px solid rgba(148,163,184,0.3);
  padding:6px 12px;
  border-radius:999px;
  display:none;
">
  Přihlášen: <span id="user-email"></span>
  · <a href="#" id="logout" style="color:#4fa3ff;text-decoration:none;">Odhlásit</a>
</div>

<div class="page">
<div class="card">
  <div class="kicker">
    <span class="dot"></span>
    Interní rozhodovací vrstva
  </div>
  <h1>SPF – Síťový provozní fond družstva WIN.WIN</h1>
  <p>
    Tato stránka slouží k <b>internímu vyhodnocení, schvalování a zamítání</b>
    přídělů do SPF a matching bonusů. Nejedná se o veřejnou prezentaci
    ani nárokový systém.
  </p>
</div>
<div class="card">
  <h2>Stav SPF za období</h2>

  <table>
    <thead>
      <tr>
        <th>Období</th>
        <th>Celkový příděl CRX</th>
        <th>Návrh do SPF</th>
        <th>Stav</th>
        <th>Akce</th>
      </tr>
    </thead>
    <tbody id="spf-periods">
      <!-- DB -->
    </tbody>
  </table>
</div>
<div class="card">
  <p>
    SPF je interní nenárokový mechanismus družstva.
    Přidělení prostředků podléhá výhradně rozhodnutí
    orgánů družstva a nepředstavuje investici,
    výnos ani garantované plnění.
  </p>
</div>
<div class="card">
  <div class="actions" style="align-items:center;">
    <span class="dot"></span>

    <button onclick="pdfSPF()">
      PDF – rozhodnutí SPF (interní)
    </button>
  </div>

  <p class="muted" style="margin-top:8px;">
    Generuje interní PDF přehled stavu SPF za zvolené období.
    Dokument slouží výhradně pro evidenci a audit družstva.
  </p>
</div>

</div>
<script type="module">
import { createClient } from
  "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
   "https://azfrniqqtetoqploxwgq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU"
);

async function loadSPF() {
  const { data, error } = await supabase
    .from("spf_periods")
    .select("*")
    .order("period", { ascending: false });

  const tbody = document.getElementById("spf-periods");
  tbody.innerHTML = "";

  if (error) {
    tbody.innerHTML =
      `<tr><td colspan="5">Chyba načtení SPF</td></tr>`;
    return;
  }

  if (!data || !data.length) {
    tbody.innerHTML =
      `<tr><td colspan="5">Zatím žádná SPF období</td></tr>`;
    return;
  }

  data.forEach(r => {

  let actions = `
  <div class="cell-actions muted">
    —
  </div>
`;

if (r.status === "draft") {
  actions = `
    <div class="cell-actions">
      <button class="approve"
        onclick="decideSPF('${r.id}','approve')">
        Schválit
      </button>
      <button class="reject"
        onclick="decideSPF('${r.id}','reject')">
        Zamítnout
      </button>
    </div>
  `;
}


  tbody.innerHTML += `
    <tr>
      <td>${r.period}</td>
      <td>${r.total_crx_assigned}</td>
      <td>${r.spf_amount}</td>
      <td>${r.status}</td>
      <td>${actions}</td>
    </tr>
  `;
});

}

loadSPF();
</script>

<script>
async function decideSPF(id, action) {

  const text =
    action === "approve"
      ? "Opravdu SCHVÁLIT SPF období?\n\nRozhodnutí bude auditně zaznamenáno."
      : "Opravdu ZAMÍTNOUT SPF období?\n\nRozhodnutí bude auditně zaznamenáno.";

  if (!confirm(text)) return;

  const session = (await supabase.auth.getSession()).data.session;

  if (!session) {
    alert("Nejste přihlášen.");
    return;
  }

  const res = await fetch(
    "https://azfrniqqtetoqploxwgq.supabase.co/functions/v1/decide_spf",
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${session.access_token}`
      },
      body: JSON.stringify({ id, action })
    }
  );

  if (!res.ok) {
    const err = await res.text();
    alert("Rozhodnutí se nezdařilo:\n" + err);
    return;
  }

  alert("Rozhodnutí bylo uloženo.");
  loadSPF(); // znovu načti tabulku
}
</script>


<script>
function pdfSPF(){
  const table = document.querySelector("table");

  if (!table) {
    alert("Tabulka SPF nebyla nalezena.");
    return;
  }

  openPdfWindow(
    "AYAS-7 · Síťový provozní fond (SPF)",
    table.outerHTML
  );
}
</script>
<script>
/* =========================================================
   AUDIT PDF WINDOW – STEJNÉ JAKO ADMIN
   ========================================================= */
function openPdfWindow(title, tableHtml) {
  const w = window.open("", "_blank");

  w.document.write(`
<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>${title}</title>
<style>
  body{
    font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
    background:#ffffff;
    color:#000000;
    padding:40px;
  }
  h1{
    font-size:22px;
    margin-bottom:6px;
  }
  .meta{
    font-size:12px;
    margin-bottom:20px;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:12px;
  }
  th,td{
    padding:8px 10px;
    border:1px solid #000;
    text-align:left;
  }
  th{
    background:#f2f2f2;
  }
  footer{
    margin-top:30px;
    font-size:11px;
  }
</style>
</head>

<body>

<h1>${title}</h1>
<div class="meta">
  Systém: AYAS-7<br>
  Typ výstupu: Interní auditní dokument<br>
  Generováno: ${new Date().toLocaleString("cs-CZ")}
</div>

${tableHtml}

<footer>
  Tento dokument je interním auditním výstupem družstva WIN.WIN.
  Nejedná se o veřejnou nabídku, investici ani nárokové plnění.
</footer>

</body>
</html>
  `);

  w.document.close();
  w.focus();
}
</script>



</body>
</html>
