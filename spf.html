<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>SPF ‚Äì S√≠≈•ov√Ω provozn√≠ fond ¬∑ WIN.WIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="module" src="./assets/js/gate.js"></script>
<!-- FAVICON / PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/ayas7-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/ayas7-512.png">
  <link rel="apple-touch-icon" href="/ayas7-192.png">
  <meta name="theme-color" content="#020617">
<style>
:root{
  --bg:#020617;
  --card:#0b1120;
  --border:rgba(148,163,184,.25);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --gold:#facc15;
  --green:#22c55e;
  --red:#ef4444;
}
html, body {
  min-height: 100%;
  margin: 0;
}

body {
  background-repeat: no-repeat;
  background-attachment: fixed;
  background-size: cover;
  background-position: center top;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  background:radial-gradient(circle at 40% 0%, #0f172a 0%, #020617 65%, #000 100%);
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
  color:var(--text);
}

.page{max-width:1400px;margin:auto;padding:42px 18px 80px}

.card{
  background:radial-gradient(circle at top left,#0b1120,#020617 70%);
  border:1px solid var(--border);
  border-radius:20px;
  padding:22px;
  margin-bottom:26px;
}

.kicker{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:6px;
}

.dot{
  width:9px;height:9px;border-radius:999px;
  background:var(--gold);
  box-shadow:
    0 0 6px var(--gold),
    0 0 16px var(--gold),
    0 0 36px rgba(250,204,21,.9);
}

h1{font-size:30px;margin-bottom:10px}
h2{font-size:18px;margin-bottom:10px}
p{font-size:13px;line-height:1.6;color:var(--muted)}

table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  table-layout:fixed;
}

/* === SPF TABULKA ‚Äì TVRD√â ZAROVN√ÅN√ç SLOUPC≈Æ === */
table{
  table-layout: fixed;
}

thead th,
tbody td{
  padding:10px;
  vertical-align:middle;
}

/* Obdob√≠ */
thead th:nth-child(1),
tbody td:nth-child(1){
  width:120px;
}

/* Celkov√Ω p≈ô√≠dƒõl CRX */
thead th:nth-child(2),
tbody td:nth-child(2){
  width:180px;
  text-align:right;
}

/* N√°vrh do SPF */
thead th:nth-child(3),
tbody td:nth-child(3){
  width:160px;
  text-align:right;
}

/* Stav */
thead th:nth-child(4),
tbody td:nth-child(4){
  width:120px;
}

/* Akce */
thead th:nth-child(5),
tbody td:nth-child(5){
  width:240px;
}


th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
}
/* === TVRD√â ZAROVN√ÅN√ç TEXTU V HLAVIƒåCE I DATECH === */
thead th{
  text-align:left;
}

tbody td{
  text-align:left;
}
/* Obdob√≠ ‚Äì HLAVIƒåKA I DATA NA STEJNOU POZICI */
thead th:nth-child(1),
tbody td:nth-child(1){
  padding-left:10px;
  text-align:left;
}


th{color:var(--muted)}

/* PEVN√â SLOUPCE ‚Äì D≈ÆLE≈ΩIT√â */
th:nth-child(1), td:nth-child(1){ width:120px; }
th:nth-child(2), td:nth-child(2){ width:180px; text-align:right; }
th:nth-child(3), td:nth-child(3){ width:160px; text-align:right; }
th:nth-child(4), td:nth-child(4){ width:120px; }
th:nth-child(5), td:nth-child(5){ width:220px; }

/* TLAƒå√çTKA */
.actions{
  display:flex;
  gap:14px;
}


button{
  padding:6px 12px;
  border-radius:10px;
  font-size:11px;
  cursor:pointer;
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
}
.approve{border-color:var(--green);color:var(--green)}
.reject{border-color:var(--red);color:var(--red)}

.dot-gold{
  background:#facc15;
  box-shadow:
    0 0 6px rgba(250,204,21,.9),
    0 0 14px rgba(250,204,21,.8),
    0 0 30px rgba(250,204,21,.6);
}
.cell-actions{
  display:flex;
  align-items:center;
  gap:12px;
  min-height:28px;
}
/* === FIX ZAROVN√ÅN√ç SPF TABULKY === */
table thead th,
table tbody td{
  vertical-align: middle;
}

/* ƒå√çSLA VPRAVO ‚Äì HLAVIƒåKA I DATA */
table th:nth-child(2),
table th:nth-child(3),
table td:nth-child(2),
table td:nth-child(3){
  text-align: right;
}

/* STAV */
table th:nth-child(4),
table td:nth-child(4){
  text-align: left;
  white-space: nowrap;
}

/* AKCE ‚Äì PEVN√ù BLOK */
table th:nth-child(5),
table td:nth-child(5){
  text-align: left;
  white-space: nowrap;
}
/* ===== NOV√Å PROVOZN√ç SEKCE ‚Äì BENEFITY ===== */
.benefit-control-box{
  margin-top:32px;
  border:1px solid rgba(34,197,94,.45);
  background:
    radial-gradient(circle at top left,
      rgba(34,197,94,.12),
      rgba(2,6,23,.95) 70%);
  border-radius:16px;
  padding:22px 24px;
}

.benefit-control-header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
}

.benefit-led{
  width:10px;
  height:10px;
  border-radius:999px;
  background:#22c55e;
  box-shadow:0 0 10px rgba(34,197,94,.9);
  flex-shrink:0;
}

.benefit-control-title{
  font-size:16px;
  font-weight:600;
  color:#eafff3;
}

.benefit-control-sub{
  font-size:13px;
  color:#c7f9dd;
  margin-bottom:16px;
  max-width:900px;
  line-height:1.45;
}

</style>
</head>

<body>
<div id="user-bar" style="
  position:fixed;
  top:12px;
  right:16px;
  z-index:9999;
  font-size:12px;
  color:#e5e7eb;
  background:rgba(2,6,23,0.85);
  border:1px solid rgba(148,163,184,0.3);
  padding:6px 12px;
  border-radius:999px;
  display:none;
">
  P≈ôihl√°≈°en: <span id="user-email"></span>
  ¬∑ <a href="#" id="logout" style="color:#4fa3ff;text-decoration:none;">Odhl√°sit</a>
</div>

<div class="page">
<div class="card">
  <div class="kicker">
    <span class="dot"></span>
    Intern√≠ rozhodovac√≠ vrstva
  </div>
  <h1>SPF ‚Äì S√≠≈•ov√Ω provozn√≠ fond dru≈æstva WIN.WIN</h1>
  <p>
    Tato str√°nka slou≈æ√≠ k <b>intern√≠mu vyhodnocen√≠, schvalov√°n√≠ a zam√≠t√°n√≠</b>
    p≈ô√≠dƒõl≈Ø do SPF a matching bonus≈Ø. Nejedn√° se o ve≈ôejnou prezentaci
    ani n√°rokov√Ω syst√©m.
  </p>
</div>
<div class="card">
  <h2>Stav SPF za obdob√≠</h2>

  <table id="spf-table">
    <thead>
      <tr>
        <th>Obdob√≠</th>
        <th>Celkov√Ω p≈ô√≠dƒõl CRX</th>
        <th>N√°vrh do SPF</th>
        <th>Stav</th>
        <th>Akce</th>
      </tr>
    </thead>
    <tbody id="spf-periods">      <!-- DB -->
    </tbody>
  </table>
</div>
<div class="card">
  <p>
    SPF je intern√≠ nen√°rokov√Ω mechanismus dru≈æstva.
    P≈ôidƒõlen√≠ prost≈ôedk≈Ø podl√©h√° v√Ωhradnƒõ rozhodnut√≠
    org√°n≈Ø dru≈æstva a nep≈ôedstavuje investici,
    v√Ωnos ani garantovan√© plnƒõn√≠.
  </p>
</div>
<div class="card">
  <div class="actions" style="align-items:center; gap:16px;">
  <span class="dot"></span>

  <button class="btn-secondary" onclick="pdfSPF()">
  PDF ‚Äì rozhodnut√≠ SPF (intern√≠)
</button>

  <p class="muted" style="margin-top:8px;">
    Generuje intern√≠ PDF p≈ôehled stavu SPF za zvolen√© obdob√≠.
    Dokument slou≈æ√≠ v√Ωhradnƒõ pro evidenci a audit dru≈æstva.
  </p>
</div>

</div>
<!-- ================= BENEFIT AVAILABILITY CONTROL ================= -->
<section class="benefit-control-box">

  <div class="benefit-control-header">
    <span class="benefit-led"></span>
    <div class="benefit-control-title">
      ≈ò√≠zen√≠ dostupnosti ƒçlensk√Ωch benefit≈Ø
    </div>
  </div>

  <div class="benefit-control-sub">
    Tato ƒç√°st slou≈æ√≠ k <b>provozn√≠mu ≈ô√≠zen√≠</b> dostupnosti benefit≈Ø
    pro ƒçleny dru≈æstva WIN.WIN.<br>
    Nejde o v√Ωpoƒçet, p≈ôidƒõlov√°n√≠ ani n√°rokov√Ω syst√©m ‚Äì pouze o urƒçen√≠,
    <b>kter√© benefity jsou v dan√© f√°zi aktivn√≠, p≈ôipravovan√© nebo pozastaven√©</b>.
    Zmƒõny jsou auditnƒõ dohledateln√©.
  </div>

  <div class="members-table-wrap">
    <table class="members-table">
      <thead>
        <tr>
          <th>N√°zev</th>
          <th>K√≥d</th>
          <th>CRX</th>
          <th>Stav</th>
          <th>Akce</th>
        </tr>
      </thead>
      <tbody id="benefitStatusTable">
        <tr>
          <td colspan="5">Naƒç√≠t√°m benefity‚Ä¶</td>
        </tr>
      </tbody>
    </table>
  </div>

</section>


<script type="module">
import { createClient } from
  "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ================================
   SUPABASE
================================ */
const supabase = createClient(
  "https://azfrniqqtetoqploxwgq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU"
);

/* ================================
   LOAD SPF
================================ */
async function loadSPF() {
  const { data } = await supabase
    .from("spf_periods")
    .select("*")
    .order("period", { ascending: false });

  const tbody = document.getElementById("spf-periods");
  tbody.innerHTML = "";

  if (!data || !data.length) {
    tbody.innerHTML =
      "<tr><td colspan='5'>≈Ω√°dn√° SPF obdob√≠</td></tr>";
    return;
  }

  data.forEach(r => {

    let actions = "‚Äî";

    if (r.status === "draft") {
      actions = `
        <div class="actions">
          <button class="approve"
            onclick="decideSPF('${r.id}','approve')">
            Schv√°lit
          </button>
          <button class="reject"
            onclick="decideSPF('${r.id}','reject')">
            Zam√≠tnout
          </button>
          <button
            onclick="openAuditSPF('${r.period}')">
            Audit SPF (PDF)
          </button>
        </div>
      `;
    }
if (r.status === "approved") {
  actions = `
    <div class="actions">
      <button
        onclick="distributeSPF('${r.id}', '${r.period}')"
        style="background:#0f172a;color:#fff">
        üîí Rozdƒõlit SPF
      </button>
      <button
        onclick="openAuditSPF('${r.period}')">
        Audit SPF (PDF)
      </button>
    </div>
  `;
}


    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.period}</td>
        <td style="text-align:right">${r.total_crx_assigned}</td>
        <td style="text-align:right">${r.spf_amount}</td>
        <td>${r.status}</td>
        <td>${actions}</td>
      </tr>
    `);
  });
}

/* ================================
   DECISION ‚Üí EDGE
================================ */
window.decideSPF = async (id, action) => {

  if (!confirm("Rozhodnut√≠ bude auditnƒõ zaznamen√°no. Pokraƒçovat?")) return;

  const session = (await supabase.auth.getSession()).data.session;
  if (!session) return alert("Nejste p≈ôihl√°≈°en.");

  await fetch(
    "https://azfrniqqtetoqploxwgq.supabase.co/functions/v1/decide_spf",
    {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${session.access_token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ id, action })
    }
  );

  loadSPF();
};

window.distributeSPF = async (spfId, period) => {
  // ‚õî OCHRANA: SPF u≈æ bylo rozdƒõleno?
  const { data: already } = await supabase
    .from("spf_distributions")
    .select("id")
    .eq("spf_period_id", spfId)
    .limit(1);

  if (already && already.length > 0) {
    alert("SPF pro toto obdob√≠ ji≈æ bylo rozdƒõleno.\nOperace je uzav≈ôena.");
    return;
  }

  if (!confirm(
    "T√≠mto krokem bude SPF rozdƒõlen podle schv√°len√Ωch benefit≈Ø.\n" +
    "Operace je auditnƒõ nevratn√°.\n\nPokraƒçovat?"
  )) return;

  const session = (await supabase.auth.getSession()).data.session;
  if (!session) return alert("Nejste p≈ôihl√°≈°en.");

  // 1Ô∏è‚É£ naƒçteme schv√°len√© benefity
  const { data: benefits, error } = await supabase
    .from("benefit_results")
    .select("id, member_id, crx_awarded")
    .eq("status", "approved")
    .eq("period", period);

  if (error || !benefits || !benefits.length) {
    alert("Neexistuj√≠ ≈æ√°dn√© schv√°len√© benefity.");
    return;
  }

  // 2Ô∏è‚É£ vytvo≈ô√≠me SPF distribuce
  for (const b of benefits) {

    const auditString =
      `${spfId}|${b.id}|${b.member_id}|${b.crx_awarded}|${Date.now()}`;

    const hashBuf = await crypto.subtle.digest(
      "SHA-256",
      new TextEncoder().encode(auditString)
    );

    const auditHash = [...new Uint8Array(hashBuf)]
      .map(b => b.toString(16).padStart(2,"0"))
      .join("");

    await supabase.from("spf_distributions").insert({
      spf_period_id: spfId,
      benefit_result_id: b.id,
      member_id: b.member_id,
      crx_amount: b.crx_awarded,
      audit_hash: auditHash,
      source: "spf.html"
    });
  }

  alert("SPF bylo √∫spƒõ≈°nƒõ rozdƒõleno.\nAuditn√≠ stopa je uzav≈ôena.");

  loadSPF();
};


/* ================================
   AUDIT ‚Üí PRINT PAGE
================================ */
window.openAuditSPF = (period) => {
  window.open(
    `/audit-print.html?type=spf&period=${encodeURIComponent(period)}`,
    "_blank"
  );
};

/* ================================
   INIT
================================ */
loadSPF();
</script>
<script>
/* =========================================================
   PDF ‚Äì ROZHODNUT√ç SPF (STEJN√Å LOGIKA JAKO ADMIN)
   ========================================================= */
function pdfSPF() {
  const table = document.getElementById("spf-table");

  if (!table) {
    alert("Tabulka SPF nebyla nalezena.");
    return;
  }

  // KL√çƒåOV√â ‚Äì p≈ôevod DOM ‚Üí HTML STRING
  const tableHtml = table.outerHTML;

  openPdfWindow(
    "AYAS-7 ¬∑ Rozhodnut√≠ SPF",
    tableHtml
  );
}
</script>
<script>
function openPdfWindow(title, contentHtml) {
  const win = window.open("", "_blank", "width=900,height=1200");

  if (!win) {
    alert("Nelze otev≈ô√≠t PDF okno. Povol vyskakovac√≠ okna.");
    return;
  }

  win.document.write(`
    <html>
      <head>
        <title>${title}</title>
        <style>
          body {
            font-family: Segoe UI, Arial, sans-serif;
            padding: 40px;
            color: #111;
          }
          h1 {
            font-size: 20px;
            margin-bottom: 20px;
          }
          table {
            width: 100%;
            border-collapse: collapse;
          }
          th, td {
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 12px;
          }
          th {
            background: #f3f4f6;
          }
        </style>
      </head>
      <body>
        <h1>${title}</h1>
        ${contentHtml}
      </body>
    </html>
  `);

  win.document.close();
  win.focus();
}
</script>
<script type="module">
import { createClient } from
  "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://azfrniqqtetoqploxwgq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU"
);

/* ===============================
   LOAD BENEFIT STATES
================================ */
async function loadBenefitStates() {
  const tbody = document.getElementById("benefitStatusTable");

  const { data, error } = await supabase
    .from("benefits")
    .select("id, name, code, crx_cost")
    .order("name");

  if (error || !data) {
    tbody.innerHTML =
      "<tr><td colspan='5'>Chyba naƒçten√≠ benefit≈Ø</td></tr>";
    return;
  }

  tbody.innerHTML = "";

  data.forEach(b => {

    let statusLabel = "‚Äî";
    if (b.status === "active") statusLabel = "üü¢ aktivn√≠";
    if (b.status === "preparing") statusLabel = "üü° p≈ôipravuje se";
    if (b.status === "paused") statusLabel = "‚õî pozastaveno";

    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${b.name}</td>
        <td><code>${b.code}</code></td>
        <td>${b.crx_cost ?? "‚Äî"}</td>
        <td>${statusLabel}</td>
        <td>
          <select
            onchange="updateBenefitStatus('${b.id}', this.value)">
            <option value="">‚Äî zmƒõnit ‚Äî</option>
            <option value="active">Aktivn√≠</option>
            <option value="preparing">P≈ôipravuje se</option>
            <option value="paused">Pozastaven</option>
          </select>
        </td>
      </tr>
    `);
  });
}

/* ===============================
   UPDATE BENEFIT STATUS
================================ */
window.updateBenefitStatus = async (id, status) => {

  if (!confirm("Zmƒõna stavu benefitu bude platn√° okam≈æitƒõ.\nPokraƒçovat?")) {
    return;
  }

  const { error } = await supabase
    .from("benefits")
    .update({
      is_active: status === "active"
    })
    .eq("id", id);

  if (error) {
    alert("Chyba p≈ôi zmƒõnƒõ stavu benefitu");
    console.error(error);
    return;
  }

  alert("Stav benefitu byl zmƒõnƒõn.");
  loadBenefitStates(); // reload tabulky ve SPF
};

/* ===============================
   INIT
================================ */
document.addEventListener("DOMContentLoaded", loadBenefitStates);
</script>


</body>
</html>
