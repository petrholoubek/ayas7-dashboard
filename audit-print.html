<script>
/* ================= ENDPOINTY ================= */
const READ =
  "https://hurayrwshmsvsylhwlbj.supabase.co/functions/v1/smart-endpoint";
const APPROVE_MEMBER =
  "https://hurayrwshmsvsylhwlbj.supabase.co/functions/v1/approve-member";
const ADD_AGENT =
  "https://hurayrwshmsvsylhwlbj.supabase.co/functions/v1/add-agent";
const APPROVE_AGENT =
  "https://hurayrwshmsvsylhwlbj.supabase.co/functions/v1/approve-agent";
const GENERATE_PROMO =
  "https://hurayrwshmsvsylhwlbj.supabase.co/functions/v1/generate-promo";

/* ================= DATA ================= */
let DATA={members:[],certificates:[],agents:[],promo:[]};

async function loadAll(){
  const r = await fetch(READ,{method:"POST"});
  DATA = await r.json();

  membersTable.innerHTML = DATA.members.map(m=>`
<tr>
<td>${m.id}</td>
<td>${m.name}<br><small>${m.email}</small></td>
<td>${m.deposit.toLocaleString()} CZK</td>
<td>${m.ww_key}</td>
<td class="status-${m.status}">${m.status}</td>
<td>
${m.status==="approved"
  ? "<span class='status-approved'>schv√°leno</span>"
  : `<button class="approve" onclick="approveMember(${m.id})">Schv√°lit</button>`}
</td>
</tr>`).join("");

  certTable.innerHTML = DATA.certificates.map(c=>`
<tr>
<td>${c.certificate_id}</td>
<td>${c.ww_keys}</td>
<td>${c.deposit_czk.toLocaleString()}</td>
<td>${new Date(c.issued_at).toLocaleDateString()}</td>
</tr>`).join("");

  agentsTable.innerHTML = DATA.agents.map(a=>`
<tr>
<td>${a.id}</td>
<td>${a.name}</td>
<td>${a.email}</td>
<td class="status-${a.status}">${a.status}</td>
<td>
${a.status==="active"
  ? `<button onclick="generatePromo(${a.id})">üéü Promo</button>`
  : `<button class="approve" onclick="approveAgent(${a.id})">Schv√°lit</button>`}
</td>
</tr>`).join("");

  promoTable.innerHTML = DATA.promo.map(p=>`
<tr>
<td>${p.code}</td>
<td>${p.agent_id}</td>
<td>${p.commission_pct ?? "-"}</td>
<td>${p.used_count ?? 0}</td>
<td>${p.status ?? "-"}</td>
<td>${p.created_at ? new Date(p.created_at).toLocaleDateString() : "-"}</td>
</tr>`).join("");
}

/* ================= AKCE ================= */
async function approveMember(id){
  await fetch(APPROVE_MEMBER,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({member_id:id})
  });
  loadAll();
}

async function addAgent(){
  await fetch(ADD_AGENT,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      name:aName.value,
      email:aEmail.value,
      phone:aPhone.value
    })
  });
  aName.value=aEmail.value=aPhone.value="";
  loadAll();
}

async function approveAgent(id){
  await fetch(APPROVE_AGENT,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({agent_id:id})
  });
  loadAll();
}

async function generatePromo(id){
  const r = await fetch(GENERATE_PROMO,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({agent_id:id})
  });
  const j = await r.json();
  alert("Promo k√≥d: " + (j.code || "nenalezen"));
  loadAll();
}

/* ================= PDF EXPORT (HTML PRINT) ================= */
/* pou≈æ√≠v√° audit-print.html ‚Äì jednotn√° AYAS-7 ≈°ablona */

function pdfMembers(){
  window.open(
    "/audit-print.html?view=members&print=1",
    "_blank"
  );
}

function pdfCertificates(){
  window.open(
    "/audit-print.html?view=certificates&print=1",
    "_blank"
  );
}

function pdfPromo(){
  window.open(
    "/audit-print.html?view=promo&print=1",
    "_blank"
  );
}

function generateOfficialAudit(){
  window.open(
    "/audit-print.html?view=official&print=1",
    "_blank"
  );
}


loadAll();

</script>
</body>
</html>
