<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>AYAS-7 Audit Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* =========================
   PRINT / BANK STYLE
   ========================= */
@page {
  size: A4;
  margin: 20mm;
}

body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: #ffffff;
  color: #000;
  font-size: 12px;
  line-height: 1.45;
}

h1, h2, h3 {
  margin: 0 0 6px 0;
}

h1 {
  font-size: 20px;
  letter-spacing: 0.04em;
}

h2 {
  font-size: 14px;
  margin-top: 18px;
  border-bottom: 1px solid #000;
  padding-bottom: 4px;
}

h3 {
  font-size: 12px;
  margin-top: 12px;
}

.section {
  margin-top: 14px;
}

.meta-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 24px;
  font-size: 11px;
}

.meta-row {
  display: flex;
  justify-content: space-between;
  border-bottom: 1px dotted #999;
}

.meta-label {
  font-weight: 600;
}

.badge {
  display: inline-block;
  padding: 2px 8px;
  border: 1px solid #000;
  font-size: 10px;
  margin-top: 4px;
}

.table-wrap {
  margin-top: 10px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 10.5px;
}

th, td {
  border: 1px solid #000;
  padding: 4px 6px;
  text-align: left;
  vertical-align: top;
}

th {
  background: #f0f0f0;
  font-weight: 600;
}

tfoot td {
  font-weight: 600;
}

.small {
  font-size: 10px;
}

.footer {
  margin-top: 18px;
  font-size: 10px;
  border-top: 1px solid #000;
  padding-top: 6px;
}

.print-btn {
  position: fixed;
  top: 10px;
  right: 10px;
  padding: 6px 12px;
  font-size: 11px;
  cursor: pointer;
}

@media print {
  .print-btn { display: none; }
}
</style>
</head>

<body>

<button class="print-btn" onclick="window.print()">Exportovat do PDF</button>

<h1>AYAS-7 Audit Report</h1>
<div class="small">
  GOVERNANCE · CONTROL · EXECUTION INTEGRITY<br>
  Deterministic FSM · SSOT · Multisignature Governance · Snapshot-Based Audit
</div>

<div class="section meta-grid">
  <div class="meta-row"><span class="meta-label">Družstvo</span><span>WIN.WIN</span></div>
  <div class="meta-row"><span class="meta-label">Systém</span><span>AYAS-7</span></div>
  <div class="meta-row"><span class="meta-label">Snapshot ID</span><span id="snapshotId">—</span></div>
  <div class="meta-row"><span class="meta-label">System State</span><span>STABLE</span></div>
  <div class="meta-row"><span class="meta-label">Generated by</span><span>ADMIN</span></div>
  <div class="meta-row"><span class="meta-label">Local Time</span><span id="localTime">—</span></div>
  <div class="meta-row"><span class="meta-label">UTC Time</span><span id="utcTime">—</span></div>
  <div class="meta-row"><span class="meta-label">Audit Hash (SHA-256)</span><span id="auditHash">—</span></div>
</div>

<div class="section">
  <h2>Executive Audit Summary</h2>
  <p>
    AYAS-7 is a deterministic control system governed by a finite state machine (FSM).
    Capital execution is restricted to predefined states and governance rules.
    No capital movement is possible without multisignature authorization.
    AI components have no execution authority.
  </p>
  <p>
    This document is descriptive only. No financial performance or outcomes are implied.
  </p>
</div>

<div class="section">
  <h2>Issued Certificates – Detail</h2>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Certificate ID</th>
          <th>Member ID</th>
          <th>WW-KEY</th>
          <th>Deposit (CZK)</th>
          <th>Hash (SHA-256)</th>
          <th>Issued At</th>
        </tr>
      </thead>
      <tbody id="certTable">
        <tr>
          <td colspan="7">Načítám data…</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3">TOTAL</td>
          <td id="totalKeys">0</td>
          <td id="totalDeposit">0</td>
          <td colspan="2"></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<div class="footer">
  This audit snapshot is protected by multisignature governance.
  No individual or system component has unilateral control.
  All critical actions require approval by multiple independent signatories
  and are permanently recorded in the audit trail.
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =========================
   SUPABASE READ-ONLY
   ========================= */
const supabaseUrl = "https://hurayrwshmsvsylhwlbj.supabase.co";
const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1cmF5cndzaG1zdnN5bGh3bGJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMTk4MzEsImV4cCI6MjA3OTc5NTgzMX0.Q0KpZX_Dln9_9OwZcCty-bbyw8drX84ax098Uy03VUI";

const db = supabase.createClient(supabaseUrl, supabaseAnonKey, {
  auth: { persistSession: false }
});

/* =========================
   INIT META
   ========================= */
const now = new Date();
document.getElementById("localTime").textContent = now.toLocaleString("cs-CZ");
document.getElementById("utcTime").textContent = now.toISOString();
document.getElementById("snapshotId").textContent =
  "AYAS7-AUDIT-" +
  now.toISOString().replace(/[-:.TZ]/g, "").slice(0, 14);

/* =========================
   LOAD CERTIFICATES
   ========================= */
(async () => {
  const { data, error } = await db
    .from("certificates")
    .select("*")
    .order("issued_at", { ascending: true });

  if (error || !data) {
    document.getElementById("certTable").innerHTML =
      "<tr><td colspan='7'>Chyba načítání dat</td></tr>";
    return;
  }

  let totalKeys = 0;
  let totalDeposit = 0;
  let concat = "";

  const tbody = document.getElementById("certTable");
  tbody.innerHTML = "";

  data.forEach((c, i) => {
    totalKeys += Number(c.ww_keys || 0);
    totalDeposit += Number(c.deposit_czk || 0);
    concat += c.hash_sha256;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${c.certificate_id}</td>
      <td>${c.member_id}</td>
      <td>${c.ww_keys}</td>
      <td>${c.deposit_czk.toLocaleString("cs-CZ")}</td>
      <td class="small">${c.hash_sha256}</td>
      <td>${new Date(c.issued_at).toLocaleString("cs-CZ")}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("totalKeys").textContent = totalKeys;
  document.getElementById("totalDeposit").textContent =
    totalDeposit.toLocaleString("cs-CZ");

  // GLOBAL AUDIT HASH
  const buf = await crypto.subtle.digest(
    "SHA-256",
    new TextEncoder().encode(concat)
  );
  const hash = [...new Uint8Array(buf)]
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");

  document.getElementById("auditHash").textContent = hash;
})();
</script>

</body>
</html>
