<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>AYAS-7 Audit Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- FAVICON / PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/ayas7-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/ayas7-512.png">
  <link rel="apple-touch-icon" href="/ayas7-192.png">
  <meta name="theme-color" content="#020617">
<style>
@page { size: A4; margin: 20mm; }

body{
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
  background:#fff;
  color:#000;
  font-size:11px;
  line-height:1.45;
}

h1{font-size:20px;margin:0}
h2{
  font-size:14px;
  margin-top:18px;
  border-bottom:1px solid #000;
  padding-bottom:4px
}

.section{margin-top:16px}

.print-btn{
  position:fixed;
  top:10px;
  right:10px;
  font-size:11px;
  padding:6px 12px;
  cursor:pointer
}

.audit-header-box{
  border:1px solid #000;
  padding:10px 12px;
  margin-top:12px;
  font-size:11px
}

.ah-row{
  display:flex;
  justify-content:space-between;
  gap:16px;
  margin-bottom:4px
}

.ah-row > div{flex:1}

.ah-hash{
  margin-top:6px;
  font-size:10px;
  word-break:break-all;
  line-height:1.35
}

.meta-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:6px 24px;
  font-size:11px
}

.meta-row{
  display:flex;
  justify-content:space-between;
  border-bottom:1px dotted #999
}

.meta-label{font-weight:600}

table{
  width:100%;
  border-collapse:collapse;
  font-size:10.5px;
  margin-top:10px
}

th,td{
  border:1px solid #000;
  padding:4px 6px;
  vertical-align:top
}

th{background:#f0f0f0}

.day-header td{
  background:#e5e7eb;
  font-weight:600
}

.small{font-size:9px;line-height:1.3}

.footer{
  margin-top:20px;
  font-size:10px;
  border-top:1px solid #000;
  padding-top:6px
}

@media print{
  .print-btn{display:none}
  .audit-header-box{page-break-inside:avoid}
  .day-header{page-break-before:always}
}
</style>
</head>

<body>

<div id="user-bar" style="
  position:fixed;
  top:12px;
  right:16px;
  z-index:9999;
  font-size:12px;
  color:#e5e7eb;
  background:rgba(2,6,23,0.85);
  border:1px solid rgba(148,163,184,0.3);
  padding:6px 12px;
  border-radius:999px;
  display:none;
">
  Přihlášen: <span id="user-email"></span>
  · <a href="#" id="logout" style="color:#4fa3ff;text-decoration:none;">Odhlásit</a>
</div>

<button class="print-btn" onclick="window.print()">Exportovat do PDF</button>

<h1>AYAS-7 AUDIT REPORT</h1>
<div style="font-size:11px;margin-bottom:6px">
GOVERNANCE · CONTROL · EXECUTION INTEGRITY<br>
Deterministic FSM · SSOT · Multisignature Governance
</div>

<div class="audit-header-box">
  <div class="ah-row">
    <div><strong>Družstvo:</strong> Podílové družstvo Win-Win</div>
    <div><strong>Systém:</strong> AYAS-7</div>
  </div>
  <div class="ah-row">
    <div><strong>Snapshot ID:</strong> <span id="snapshotId"></span></div>
    <div><strong>System State:</strong> STABLE</div>
  </div>

<div class="ah-row">
  <div>
    <strong>SPF rozhodnutí:</strong>
    <span id="spfDecisionStatus">—</span>
  </div>
  <div>
    <strong>Rozhodl:</strong>
    <span id="spfApprovedBy">—</span>
  </div>
</div>

<div class="ah-row">
  <div>
    <strong>Rozhodnuto dne:</strong>
    <span id="spfApprovedAt">—</span>
  </div>
  <div>
    <strong>Schválil:</strong>
    <span id="spfApprovedBy">—</span>
  </div>
  <div>
    <strong>Zdroj rozhodnutí:</strong>
    <span id="spfDecisionSource">—</span>
  </div>
</div>

  <div class="ah-row">
    <div><strong>Generated (local):</strong> <span id="localTime"></span></div>
    <div><strong>Generated (UTC):</strong> <span id="utcTime"></span></div>
  </div>
  <div class="ah-hash">
    <strong>Audit Hash (SHA-256):</strong>
    <span id="auditHash"></span>
  </div>
</div>

<div class="section">
<h2>Executive Overview</h2>
<div class="meta-grid">
  <div class="meta-row"><span class="meta-label">Celkem vydané WW-KEY</span><span id="sumKeys">—</span></div>
  <div class="meta-row"><span class="meta-label">Celkový objem vkladů (CZK)</span><span id="sumDeposit">—</span></div>
  <div class="meta-row"><span class="meta-label">Počet certifikátů</span><span id="sumCerts">—</span></div>
  <div class="meta-row"><span class="meta-label">Auditované období</span><span id="auditRange">—</span></div>
</div>
</div>
<div class="section">
<h2>AYAS-7 – Souhrn rozdělení benefitní kapacity</h2>

<table>
  <tbody>
    <tr>
      <td><strong>Celkový výstup AYAS-7 (CRX)</strong></td>
      <td id="crx-total">—</td>
    </tr>
    <tr>
      <td>Alokováno členům (CRX)</td>
      <td id="crx-members">—</td>
    </tr>
    <tr>
      <td>Vyčleněno do SPF (CRX)</td>
      <td id="crx-spf">—</td>
    </tr>
    <tr>
      <td>Nealokovaná rezerva (CRX)</td>
      <td id="crx-reserve">—</td>
    </tr>
  </tbody>
</table>

<p class="small">
Uvedené hodnoty představují agregovaný výstup výpočtového systému AYAS-7
za auditované období. Nejedná se o finanční plnění, nárok ani závazek.
</p>
</div>
<div class="section">
<h2>SPF Distribution Summary</h2>

<div class="meta-grid">
  <div class="meta-row">
    <span class="meta-label">SPF období</span>
    <span id="spfPeriod">—</span>
  </div>
  <div class="meta-row">
    <span class="meta-label">Celkový SPF objem (CRX)</span>
    <span id="spfTotal">—</span>
  </div>
  <div class="meta-row">
    <span class="meta-label">Rozděleno členům (CRX)</span>
    <span id="spfDistributed">—</span>
  </div>
  <div class="meta-row">
    <span class="meta-label">Nerozdělený zůstatek (CRX)</span>
    <span id="spfRemaining">—</span>
  </div>
  <div class="meta-row">
    <span class="meta-label">Stav SPF</span>
    <span id="spfStatus">—</span>
  </div>
</div>
</div>

<div class="section">
<h2>Issued Certificates – Detail</h2>
<table>
<thead>
<tr>
  <th>#</th>
  <th>Certificate ID</th>
  <th>Member ID</th>
  <th>WW-KEY</th>
  <th>Deposit (CZK)</th>
  <th>Hash (SHA-256)</th>
  <th>Issued At</th>
</tr>
</thead>
<tbody id="certTable">
<tr><td colspan="7">Načítám data…</td></tr>
</tbody>
</table>
</div>

<div class="footer">
This audit snapshot is read-only and derived directly from issued certificates
stored in the AYAS-7 system database.
</div>


<!-- ================= SUPABASE ================= -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const supabaseUrl = "https://azfrniqqtetoqploxwgq.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU";

  const db = supabase.createClient(supabaseUrl, supabaseAnonKey);

// ================= GENESIS AUDIT SUMMARY =================

const { data: auditRow } = await db
  .from("v_admin_full_audit")
  .select("*")
  .single();

if (auditRow) {
  document.getElementById("sumCerts").textContent =
    auditRow.issued_certificates ?? "0";

  document.getElementById("sumKeys").textContent =
    Number(auditRow.total_wwkey || 0).toLocaleString("cs-CZ");

  document.getElementById("sumDeposit").textContent =
    Number(auditRow.total_deposit_czk || 0).toLocaleString("cs-CZ");

  if (auditRow.first_certificate_at && auditRow.last_certificate_at) {
    document.getElementById("auditRange").textContent =
      new Date(auditRow.first_certificate_at).toLocaleDateString("cs-CZ") +
      " → " +
      new Date(auditRow.last_certificate_at).toLocaleDateString("cs-CZ");
  }
}


  const now = new Date();
  document.getElementById("localTime").textContent = now.toLocaleString("cs-CZ");
  document.getElementById("utcTime").textContent = now.toISOString();
  document.getElementById("snapshotId").textContent =
    "AYAS7-AUDIT-" + now.toISOString().replace(/[-:.TZ]/g,"").slice(0,14);

  const tbody = document.getElementById("certTable");

  const { data, error } = await db
    .from("member_certificates")
    .select("*")
    .order("issued_at", { ascending:true });

  if (error || !data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='7'>Žádná data</td></tr>";
    return;
  }

  let idx = 1;
  let totalKeys = 0;
  let totalDeposit = 0;
  let concatHash = "";
  const byDay = {};

  data.forEach(c => {
    const day = c.issued_at.slice(0,10);
    if (!byDay[day]) byDay[day] = [];
    byDay[day].push(c);
  });

  tbody.innerHTML = "";

  Object.keys(byDay).forEach(day => {

    let dKeys = 0, dDep = 0;

    byDay[day].forEach(c=>{
      dKeys += Number(c.ww_key_amount || 0);
      dDep  += Number(c.deposit_amount || 0);
    });

    tbody.insertAdjacentHTML("beforeend", `
      <tr class="day-header">
        <td colspan="7">
          ${day} — ${byDay[day].length} certifikátů ·
          ${dKeys} WW-KEY ·
          ${dDep.toLocaleString("cs-CZ")} CZK
        </td>
      </tr>
    `);

    byDay[day].forEach(c=>{
      totalKeys += Number(c.ww_key_amount || 0);
      totalDeposit += Number(c.deposit_amount || 0);

// hash počítáme deterministicky z obsahu
concatHash += `${c.certificate_uid}|${c.deposit_amount}|${c.ww_key_amount}|${c.issued_at}`;


      tbody.insertAdjacentHTML("beforeend", `
        <tr>
  <td>${idx++}</td>
  <td>${c.certificate_uid}</td>
  <td>${c.member_name}</td>
  <td>${c.ww_key_amount}</td>
  <td>${c.deposit_amount.toLocaleString("cs-CZ")}</td>
  <td>${new Date(c.issued_at).toLocaleString("cs-CZ")}</td>
</tr>

      `);
    });
  });

  document.getElementById("sumCerts").textContent = data.length;
  document.getElementById("sumKeys").textContent = totalKeys.toLocaleString("cs-CZ");
  document.getElementById("sumDeposit").textContent = totalDeposit.toLocaleString("cs-CZ");
  document.getElementById("auditRange").textContent =
    Object.keys(byDay)[0] + " → " + Object.keys(byDay).slice(-1)[0];

  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(concatHash));
  document.getElementById("auditHash").textContent =
    [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");

 // ================= AYAS-7 DISTRIBUTION =================

// 1️⃣ CRX přidělené členům
const { data: benefitRows } = await db
  .from("benefit_results")
  .select("crx_awarded");

const crxMembers = (benefitRows || []).reduce(
  (sum, r) => sum + Number(r.crx_awarded || 0),
  0
);

// 2️⃣ SPRÁVNÉ OBDOBÍ (YYYY-MM)
const auditPeriod = Object.keys(byDay)[0].slice(0, 7);

// 3️⃣ SPF FUND – FINÁLNÍ AUDIT DATA
const { data: spfRow } = await db
  .from("spf_fund_periods")
  .select("id, spf_amount_total, status, decided_at, decided_by")
  .eq("period", auditPeriod)
  .maybeSingle();

// 4️⃣ ZÁKLADNÍ HODNOTY
const crxSpf = Number(spfRow?.spf_amount_total || 0);
const crxTotal = crxMembers + crxSpf;
const crxReserve = 0;

// ================= SPF DISTRIBUTION (REAL DATA) =================

let spfDistributed = 0;
let spfRemaining = crxSpf;

// 5️⃣ POUZE POKUD SPF EXISTUJE
if (spfRow?.id) {
  const { data: spfDistRows } = await db
    .from("spf_distributions")
    .select("crx_amount")
    .eq("spf_period_id", spfRow.id);

  spfDistributed = (spfDistRows || []).reduce(
    (sum, r) => sum + Number(r.crx_amount || 0),
    0
  );

  spfRemaining = crxSpf - spfDistributed;
}


// ================= SPF METADATA → AUDIT HEADER & SUMMARY =================

document.getElementById("spfPeriod").textContent =
  auditPeriod;

document.getElementById("spfTotal").textContent =
  crxSpf.toLocaleString("cs-CZ");

document.getElementById("spfDistributed").textContent =
  spfDistributed.toLocaleString("cs-CZ");

document.getElementById("spfRemaining").textContent =
  spfRemaining.toLocaleString("cs-CZ");

let spfStatus = "—";

if (!spfRow) {
  spfStatus = "NO PERIOD";
} else if (spfDistributed === 0) {
  spfStatus = "ALLOCATED (NOT DISTRIBUTED)";
} else if (spfDistributed < crxSpf) {
  spfStatus = "PARTIALLY DISTRIBUTED";
} else if (spfDistributed === crxSpf) {
  spfStatus = "FULLY DISTRIBUTED";
} else {
  spfStatus = "INCONSISTENT";
}

document.getElementById("spfStatus").textContent = spfStatus;

// ===== HLAVIČKA AUDITU =====

document.getElementById("spfDecisionStatus").textContent =
  spfRow?.status ?? "—";

document.getElementById("spfApprovedAt").textContent =
  spfRow?.decided_at
    ? new Date(spfRow.decided_at).toLocaleString("cs-CZ")
    : "—";

document.getElementById("spfApprovedBy").textContent =
  spfRow?.decided_by ?? "—";

document.getElementById("spfDecisionSource").textContent = "AYAS-7 ENGINE";

// ===== SOUHRN CRX =====

document.getElementById("crx-members").textContent =
  crxMembers.toLocaleString("cs-CZ");

document.getElementById("crx-spf").textContent =
  crxSpf.toLocaleString("cs-CZ");

document.getElementById("crx-total").textContent =
  crxTotal.toLocaleString("cs-CZ");

document.getElementById("crx-reserve").textContent =
  crxReserve.toLocaleString("cs-CZ");

  setTimeout(()=>window.print(),300);
});
</script>

</body>
</html>
