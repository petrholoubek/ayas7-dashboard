<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>AYAS-7 • Audit Print</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
  background:#020617;
  color:#e5e7eb;
  margin:0;
  padding:24px;
}
h1{font-size:22px;margin-bottom:4px}
.meta{font-size:12px;color:#94a3b8;margin-bottom:18px}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th,td{
  border-bottom:1px solid #1e293b;
  padding:6px 8px;
  text-align:left;
}
th{
  color:#94a3b8;
  font-size:11px;
}
.day-header td{
  background:#020617;
  color:#22c55e;
  font-weight:600;
  border-top:2px solid #22c55e;
}
.summary{
  margin-top:18px;
  font-size:13px;
}
.summary span{display:inline-block;margin-right:18px}
.hash{
  margin-top:12px;
  font-size:11px;
  word-break:break-all;
  color:#9ca3af;
}
@media print{
  body{background:#fff;color:#000}
  .day-header td{color:#000}
}
</style>
</head>

<body>

<h1>Audit certifikátů AYAS-7</h1>
<div class="meta">
  Lokální čas: <span id="localTime"></span> |
  UTC: <span id="utcTime"></span><br>
  Snapshot ID: <span id="snapshotId"></span>
</div>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Certifikát</th>
  <th>Member ID</th>
  <th>WW-KEY</th>
  <th>Vklad CZK</th>
  <th>Hash</th>
  <th>Vydáno</th>
</tr>
</thead>
<tbody id="certTable">
<tr><td colspan="7">Načítám data…</td></tr>
</tbody>
</table>

<div class="summary">
  <span>Certifikátů: <b id="sumCerts">0</b></span>
  <span>WW-KEY: <b id="sumKeys">0</b></span>
  <span>Vklad CZK: <b id="sumDeposit">0</b></span><br>
  Rozsah: <span id="auditRange"></span>
</div>

<div class="hash">
  Audit hash: <span id="auditHash"></span>
</div>

<!-- ================= SUPABASE ================= -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const supabaseUrl = "https://hurayrwshmsvsylhwlbj.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1cmF5cndzaG1zdnN5bGh3bGJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMTk4MzEsImV4cCI6MjA3OTc5NTgzMX0.Q0KpZX_Dln9_9OwZcCty-bbyw8drX84ax098Uy03VUI";

  const db = supabase.createClient(supabaseUrl, supabaseAnonKey);

  const now = new Date();
  document.getElementById("localTime").textContent = now.toLocaleString("cs-CZ");
  document.getElementById("utcTime").textContent = now.toISOString();
  document.getElementById("snapshotId").textContent =
    "AYAS7-AUDIT-" + now.toISOString().replace(/[-:.TZ]/g,"").slice(0,14);

  const tbody = document.getElementById("certTable");

  const { data, error } = await db
    .from("certificates")
    .select("*")
    .order("issued_at", { ascending:true });

  if (error || !data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='7'>Žádná data</td></tr>";
    return;
  }

  let idx = 1;
  let totalKeys = 0;
  let totalDeposit = 0;
  let concatHash = "";
  const byDay = {};

  data.forEach(c => {
    const day = c.issued_at.slice(0,10);
    if (!byDay[day]) byDay[day] = [];
    byDay[day].push(c);
  });

  tbody.innerHTML = "";

  Object.keys(byDay).forEach(day => {

    let dKeys = 0, dDep = 0;

    byDay[day].forEach(c=>{
      dKeys += Number(c.ww_keys||0);
      dDep  += Number(c.deposit_czk||0);
    });

    tbody.insertAdjacentHTML("beforeend", `
      <tr class="day-header">
        <td colspan="7">
          ${day} — ${byDay[day].length} certifikátů ·
          ${dKeys} WW-KEY ·
          ${dDep.toLocaleString("cs-CZ")} CZK
        </td>
      </tr>
    `);

    byDay[day].forEach(c=>{
      totalKeys += Number(c.ww_keys||0);
      totalDeposit += Number(c.deposit_czk||0);
      concatHash += c.hash_sha256 || "";

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${idx++}</td>
          <td>${c.certificate_id}</td>
          <td>${c.member_id}</td>
          <td>${c.ww_keys}</td>
          <td>${c.deposit_czk.toLocaleString("cs-CZ")}</td>
          <td>${c.hash_sha256}</td>
          <td>${new Date(c.issued_at).toLocaleString("cs-CZ")}</td>
        </tr>
      `);
    });
  });

  document.getElementById("sumCerts").textContent = data.length;
  document.getElementById("sumKeys").textContent = totalKeys.toLocaleString("cs-CZ");
  document.getElementById("sumDeposit").textContent = totalDeposit.toLocaleString("cs-CZ");
  document.getElementById("auditRange").textContent =
    Object.keys(byDay)[0] + " → " + Object.keys(byDay).slice(-1)[0];

  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(concatHash));
  document.getElementById("auditHash").textContent =
    [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");

  setTimeout(()=>window.print(),300);
});
</script>

</body>
</html>
