<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Členská karta – interní výjezd</title>

<style>
/* ======================================================
   PDF – MEMBER INTELLIGENCE CARD
====================================================== */
@page{
  size:A4;
  margin:22mm 18mm;
}

body{
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
  background:#ffffff;
  color:#111827;
  font-size:12px;
}

h1,h2,h3{
  margin:0;
  font-weight:600;
}

hr{
  border:none;
  border-top:1px solid #d1d5db;
  margin:18px 0;
}

/* ======================================================
   HLAVIČKA
====================================================== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.logo{
  font-size:18px;
  font-weight:700;
  letter-spacing:.08em;
}

.logo span{
  color:#b45309;
}

.doc-title{
  text-align:right;
}

.doc-title h1{
  font-size:16px;
}

.doc-title p{
  font-size:10px;
  color:#6b7280;
}

/* ======================================================
   INFO BOX
====================================================== */
.info-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}

.box{
  border:1px solid #e5e7eb;
  border-radius:8px;
  padding:10px 12px;
}

.box h3{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.12em;
  color:#6b7280;
  margin-bottom:6px;
}

.value{
  font-size:13px;
  font-weight:600;
}

/* ======================================================
   TABULKY
====================================================== */
table{
  width:100%;
  border-collapse:collapse;
  font-size:11px;
}

th,td{
  padding:8px 6px;
  border-bottom:1px solid #e5e7eb;
  text-align:left;
}

th{
  color:#6b7280;
  font-weight:600;
}

/* ======================================================
   FOOTER
====================================================== */
.footer{
  margin-top:28px;
  font-size:9px;
  color:#6b7280;
}

.audit{
  margin-top:10px;
  font-family:monospace;
  font-size:9px;
  word-break:break-all;
}

/* ======================================================
   PRINT FIX – ZÁKAZ LÁMÁNÍ BLOKŮ
====================================================== */
@media print {

  /* nikdy nelámej boxy */
  .box,
  table,
  tr {
    page-break-inside: avoid;
    break-inside: avoid;
  }

  /* hlavičky nikdy na konci stránky */
  h1, h2, h3 {
    page-break-after: avoid;
    break-after: avoid;
  }

  /* oddělovače nepoužívej jako místo zlomu */
  hr {
    page-break-before: avoid;
    page-break-after: avoid;
  }

}

</style>
</head>

<body>

<!-- ======================================================
     HLAVIČKA
====================================================== -->
<div class="header">
  <div class="logo">
    AYAS-7 <span>WIN.WIN</span>
  </div>

  <div class="doc-title">
    <h1>Členská karta – interní výjezd</h1>
    <p>Member Intelligence Card</p>
  </div>
</div>

<hr>

<!-- ======================================================
     IDENTIFIKACE DOKUMENTU
====================================================== -->
<div class="info-grid">
  <div class="box">
    <h3>Dokument</h3>
    <div class="value">Interní výstup systému</div>
  </div>

  <div class="box">
    <h3>Datum generování</h3>
    <div class="value"><span id="pdf-generated">—</span></div>
  </div>
</div>

<hr>

<!-- ======================================================
     IDENTITA ČLENA
====================================================== -->
<div class="box">
  <h3>Identita člena</h3>

  <div class="info-grid">
    <div>
      Jméno:<br>
      <b><span id="pdf-name">—</span></b>
    </div>
    <div>
      Email:<br>
      <b><span id="pdf-email">—</span></b>
    </div>
    <div>
      ID člena:<br>
      <b><span id="pdf-id">—</span></b>
    </div>
    <div>
      Stav členství:<br>
      <b><span id="pdf-status">—</span></b>
    </div>
  </div>
</div>


<hr>

<!-- ======================================================
     ANGAŽOVANOST & ROLE
====================================================== -->
<div class="box">
  <h3>Angažovanost a role</h3>

<table>
  <tr>
    <th>Aktuální role</th>
    <td id="pdf-role">—</td>
  </tr>
  <tr>
    <th>Matching dle rámce</th>
    <td>—</td>
  </tr>
</table>


  <p style="font-size:10px;color:#6b7280">
    Kariérní role a matching nejsou v tomto dokumentu
    závazné ani nárokové. Slouží pouze k interní orientaci.
  </p>
</div>

<hr>

<hr>

<hr>

<!-- ======================================================
     WW-KEY & CERTIFIKÁTY
====================================================== -->
<div class="box">
  <h3>WW-KEY & certifikáty</h3>

  <div style="margin-bottom:10px">
    <b>WW-KEY (celkem):</b>
    <span id="pdf-wwkey-total">—</span>
  </div>

<table style="width:100%; border-collapse:collapse;">
  <thead>
    <tr>
      <th>Certifikát</th>
      <th>Hodnota WW-KEY</th>
      <th>Vklad</th>
      <th>Datum vydání</th>
    </tr>
  </thead>

  <!-- ⬇️ SEM SCRIPT VYGENERUJE ŘÁDKY ⬇️ -->
  <tbody id="pdf-certificates">
    <tr>
      <td colspan="4">Načítám certifikáty…</td>
    </tr>
  </tbody>
</table>


  <p style="font-size:10px;color:#6b7280;margin-top:8px">
    WW-KEY je součtem schválených certifikátů.
    Uvedené hodnoty představují auditní snapshot ke dni generování dokumentu.
  </p>
</div>


<!-- ======================================================
     BENEFITY ČLENA
====================================================== -->
<div class="box">
  <h3>Členské benefity</h3>

  <table>
    <thead>
      <tr>
        <th>Název benefitu</th>
        <th>Období</th>
        <th>Stav</th>
        <th>Poznámka</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Výkonnostní bonus</td>
        <td>12 / 2025</td>
        <td>Schválen</td>
        <td>Rozhodnutí výboru SPF</td>
      </tr>
      <tr>
        <td>Partnerský benefit</td>
        <td>01 / 2026</td>
        <td>Čeká na schválení</td>
        <td>—</td>
      </tr>
    </tbody>
  </table>

  <p style="font-size:10px;color:#6b7280;margin-top:8px">
    Uvedené benefity nejsou nárokové. Přidělení podléhá rozhodnutí
    orgánů družstva a může být kdykoliv změněno nebo odebráno.
  </p>
</div>


<!-- ======================================================
     SPF
====================================================== -->
<div class="box">
  <h3>SPF & rozhodnutí družstva</h3>

  <table>
    <tr>
      <th>Účast ve SPF</th>
      <td>Ano</td>
    </tr>
    <tr>
      <th>Poslední období</th>
      <td>12 / 2025</td>
    </tr>
    <tr>
      <th>Rozhodnutí</th>
      <td>Schváleno</td>
    </tr>
  </table>
</div>

<hr>

<!-- ======================================================
     CRX – INTERNÍ PŘIDĚLENÍ (UZAVŘENÁ OBDOBÍ)
====================================================== -->
<div class="box">
  <h3>CRX – interní přidělení (uzavřená období)</h3>

  <table>
    <thead>
      <tr>
        <th>Období</th>
        <th>Program</th>
        <th>Typ</th>
        <th style="text-align:right">CRX</th>
      </tr>
    </thead>
    <tbody id="pdf-crx">
      <tr>
        <td colspan="4">Načítám CRX…</td>
      </tr>
    </tbody>
  </table>

  <p style="font-size:10px;color:#6b7280;margin-top:8px">
    CRX jsou interní nepeněžní jednotky přidělené na základě
    rozhodnutí družstva v uzavřených obdobích.
    Nejedná se o zůstatek ani nárokový účet.
  </p>
</div>

<hr>


<!-- ======================================================
     KARIÉRNÍ RÁMEC (READ-ONLY)
====================================================== -->
<div class="no-break">
  <div class="box">
    <h3>Kariérní rámec</h3>
  <p style="font-size:10px;color:#6b7280">
    Uvedené hodnoty představují maximální odpovědnostní rámec.
    Přidělení role není nárokové.
  </p>
</div>

<hr>

<!-- ======================================================
     AUDIT
====================================================== -->
<div class="footer">
  <b>Auditní informace</b><br>
  Tento dokument byl vygenerován systémem AYAS-7 jako
  snapshot interního stavu člena.
  Nejedná se o nabídku, investiční doporučení ani právní nárok.

  <div class="audit">
    Audit ID: AYAS7-MIC-20260115-143200<br>
    Hash: 9bcbd59c6d9f42fcbb7aea17de2ba98092c1b1d9cdab94a1d8eb4a8650809f5f
  </div>
</div>

<script type="module">
import { createClient } from
  "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ===============================
   SUPABASE CLIENT
=============================== */
const supabase = createClient(
  "https://azfrniqqtetoqploxwgq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU"
);

/* ===============================
   PARAMETRY
=============================== */
const params = new URLSearchParams(window.location.search);
const email = params.get("email");

if (!email) {
  document.body.innerHTML = "<p>Chybí identifikace člena.</p>";
  throw new Error("Missing email");
}

/* ===============================
   LOAD MEMBER
=============================== */
const { data: member, error: memberError } = await supabase
  .from("members_data")
  .select("*")
  .eq("email", email)
  .single();

if (memberError || !member) {
  document.body.innerHTML = "<p>Člen nebyl nalezen.</p>";
  throw memberError;
}

/* ===== IDENTITA ===== */
document.getElementById("pdf-name").textContent =
  member.full_name || member.name || "—";
document.getElementById("pdf-email").textContent = member.email;
document.getElementById("pdf-id").textContent = member.id;
document.getElementById("pdf-status").textContent = member.status || "—";
document.getElementById("pdf-generated").textContent =
  new Date().toLocaleString("cs-CZ");

/* ===============================
   LOAD CAREER (READ-ONLY)
=============================== */
const { data: career } = await supabase
  .from("v_agents_career")
  .select("role_code, role_name")
  .eq("email", member.email)
  .single();

document.getElementById("pdf-role").textContent =
  career
    ? `${career.role_code} – ${career.role_name}`
    : "—";

/* ===============================
   LOAD CERTIFICATES & WW-KEY
=============================== */
const { data: certs } = await supabase
  .from("member_certificates")
  .select("certificate_uid, ww_key_amount, deposit_amount, issued_at")
  .eq("member_id", member.id);

const tbody = document.getElementById("pdf-certificates");
const totalSpan = document.getElementById("pdf-wwkey-total");

let total = 0;
tbody.innerHTML = "";

if (!certs || certs.length === 0) {
  tbody.innerHTML =
    "<tr><td colspan='4'>Žádné certifikáty nenalezeny</td></tr>";
  totalSpan.textContent = "0";
} else {
  certs.forEach(c => {
    total += Number(c.ww_key_amount || 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.certificate_uid}</td>
      <td>${c.ww_key_amount}</td>
      <td>${c.deposit_amount}</td>
      <td>${c.issued_at
        ? new Date(c.issued_at).toLocaleDateString("cs-CZ")
        : "—"}</td>
    `;
    tbody.appendChild(tr);
  });
  totalSpan.textContent = total.toLocaleString("cs-CZ");
}

/* ===============================
   LOAD CRX (UZAVŘENÁ OBDOBÍ)
=============================== */
const { data: crxRows } = await supabase
  .from("v_spf_distribution_export")
  .select("period, program_name, program_type, matching_bonus_crx")
  .eq("member_id", member.user_id)
  .order("period", { ascending: false });

const crxBody = document.getElementById("pdf-crx");
crxBody.innerHTML = "";

if (!crxRows || crxRows.length === 0) {
  crxBody.innerHTML =
    "<tr><td colspan='4'>Žádné CRX nebyly dosud přiděleny</td></tr>";
} else {
  crxRows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.period}</td>
      <td>${r.program_name}</td>
      <td>${r.program_type}</td>
      <td style="text-align:right">${r.matching_bonus_crx}</td>
    `;
    crxBody.appendChild(tr);
  });
}

</script>



</body>
</html>
