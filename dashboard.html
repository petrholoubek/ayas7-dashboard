<!-- DASHBOARD LIVE ENGINE â€“ FULL FIXED VERSION -->
<script>
document.addEventListener("DOMContentLoaded",()=>{

  console.log("ðŸ”— DASHBOARD INITIALIZED");

  /* -------------------  GRAFY ------------------- */

  const ctxU = document.getElementById("chartUsdtz")?.getContext("2d");
  const ctxG = document.getElementById("chartGusd")?.getContext("2d");

  const chartUsdtz = new Chart(ctxU,{
    type:"line",
    data:{labels:[],datasets:[{borderColor:"#4fa3ff",tension:.35,pointRadius:0,data:[]}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
  });

  const chartGusd = new Chart(ctxG,{
    type:"line",
    data:{labels:[],datasets:[{borderColor:"#22c55e",tension:.35,pointRadius:0,data:[]}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
  });

  function updateCharts(state){
    if(!state.history?.length) return;
    const h = state.history.slice(-32);
    const L = h.map((_,i)=>"T"+(i+1));

    chartUsdtz.data.labels = L;
    chartUsdtz.data.datasets[0].data = h.map(p=>p.yieldRate);
    chartUsdtz.update("none");

    chartGusd.data.labels = L;
    chartGusd.data.datasets[0].data = h.map(p=>p.nodesOnline*0.35+3);
    chartGusd.update("none");
  }


  /* -------------------  LED PÃSKY ------------------- */

  function updateLED(state){
    const values = [
      state.yieldRate,
      state.yieldRate*0.87,
      state.yieldRate*1.2,
      100-state.yieldRate,
      state.nodesOnline*3,
      state.nodesOnline*2,
      state.yieldRate*1.4,
      state.yieldRate,
      state.nodesOnline*2
    ];

    document.querySelectorAll(".card-bar-fill").forEach((bar,i)=>{
      let v = Math.max(0,Math.min(100,values[i]||0));
      bar.style = `--fill:${v}%`;
    });
  }


  /* -------------------  BIND NA CHIP CORE ------------------- */

  if(window.AYASCore){
    console.log("ðŸ§  CORE DETECTED â€“ LIVE MODE ðŸ”¥");

    AYASCore.subscribe(state=>{
      updateCharts(state);
      updateLED(state);
    });

  } else {
    console.warn("âš  CORE NOT FOUND â€“ fallback activated.");

    setInterval(()=>{
      const d = chartUsdtz.data.datasets[0].data;
      d.push((d[d.length-1]||5.4)+(Math.random()-0.5)*.15);
      if(d.length>32) d.shift();
      chartUsdtz.update("none");
    },1300);
  }

});
</script>
