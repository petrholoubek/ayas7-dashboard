<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>AYAS-7 ¬∑ Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="module" src="./assets/js/gate.js"></script>
  
<!-- FAVICON / PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/ayas7-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/ayas7-512.png">
  <link rel="apple-touch-icon" href="/ayas7-192.png">
  <meta name="theme-color" content="#020617">
<style>
:root{
  --bg:#020617;
  --panel:#0b1222;
  --panel-soft:#0f172acc;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;

  --green:#22c55e;
  --blue:#38bdf8;
  --yellow:#facc15;
}

*{box-sizing:border-box}

html,body{
  margin:0;
  padding:0;
  background:radial-gradient(1200px 600px at top,#020617,#000);
  color:var(--text);
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
}

a{color:inherit;text-decoration:none}

/* === WRAPPER === */
.admin-wrap{
  max-width:1200px;
  margin:0 auto;
  padding:28px 20px 40px;
  display:flex;
  flex-direction:column;
  gap:26px;
}

/* === HEADER === */
.admin-header{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.admin-title{
  font-size:26px;
  font-weight:600;
  letter-spacing:.04em;
}

.admin-sub{
  font-size:13px;
  color:var(--muted);
}

/* === QUICK ACTIONS === */
.quick-actions{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:18px;
}

.qa-box{
  position:relative;
  background:linear-gradient(180deg,#0b1222,#020617);
  border:1px solid var(--border);
  border-radius:20px;
  padding:22px;
  transition:transform .25s ease, box-shadow .25s ease;
}

.qa-box:hover{
  transform:translateY(-3px);
  box-shadow:0 18px 40px rgba(0,0,0,.45);
}

.qa-led{
  position:absolute;
  top:16px;
  right:16px;
  width:10px;
  height:10px;
  border-radius:50%;
}

.qa-title{
  font-size:15px;
  font-weight:600;
  margin-bottom:6px;
}

.qa-desc{
  font-size:12px;
  color:var(--muted);
  margin-bottom:14px;
}

.qa-cta{
  font-size:12px;
  font-weight:600;
  letter-spacing:.02em;
}

/* COLORS */
.qa-spf{border-color:var(--yellow)}
.qa-spf .qa-led{background:var(--yellow);box-shadow:0 0 14px var(--yellow)}

.qa-member{border-color:var(--blue)}
.qa-member .qa-led{background:var(--blue);box-shadow:0 0 14px var(--blue)}

.qa-audit{border-color:var(--green)}
.qa-audit .qa-led{background:var(--green);box-shadow:0 0 14px var(--green)}

/* === STATUS PANELS === */
.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
}

.stat{
  position:relative;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px 20px;
}

.stat::after{
  content:"";
  position:absolute;
  top:14px;
  right:14px;
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--green);
  box-shadow:0 0 12px var(--green);
}

.stat-title{
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}

.stat-value{
  font-size:22px;
  font-weight:600;
}

/* === SECTIONS === */
.section{
  background:var(--panel-soft);
  border:1px solid var(--border);
  border-radius:22px;
  padding:22px;
}

.section h2{
  margin:0 0 6px;
  font-size:16px;
}

.section p{
  margin:0 0 14px;
  font-size:12px;
  color:var(--muted);
}

/* === TABLE === */
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:left;
}

th{
  font-size:11px;
  color:var(--muted);
}

/* === CERTIFICATION BUTTON === */
.btn{
  display:inline-block;
  padding:8px 14px;
  font-size:12px;
  border-radius:999px;
  border:1px solid var(--border);
}

.btn-green{
  border-color:var(--green);
  color:var(--green);
}

/* === AUDIT PANEL === */
.audit-box{
  border:1px dashed var(--blue);
  border-radius:16px;
  padding:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* === FOOTER === */
.footer{
  text-align:center;
  font-size:11px;
  color:var(--muted);
  margin-top:30px;
}

/* =========================================================
   AYAS-7 ADMIN ‚Äì JEDNOTN√â POZAD√ç (FIN√ÅL)
   ========================================================= */

/* 1Ô∏è‚É£ CEL√Å STR√ÅNKA ‚Äì JEDNO POZAD√ç */
html, body {
  margin: 0;
  padding: 0;
  min-height: 100%;
  background:
    radial-gradient(
      1200px 600px at 20% -10%,
      #0b1220 0%,
      #020617 60%
    );
  color: #e5e7eb;
  font-family: "Segoe UI", Tahoma, Verdana, sans-serif;
}

/* 2Ô∏è‚É£ HLAVN√ç KONTEJNER ADMINU */
.admin-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 48px 24px 64px;
}

/* 3Ô∏è‚É£ SEKCE JSOU PR≈ÆHLEDN√â (NELEP√ç SE) */
.section {
  background: transparent;
  margin-bottom: 32px;
}

/* 4Ô∏è‚É£ KARTY / BOXY ‚Äì JEDIN√â M√çSTO S POZAD√çM */
.card {
  background: linear-gradient(
    180deg,
    rgba(15, 23, 42, 0.95),
    rgba(2, 6, 23, 0.95)
  );
  border: 1px solid rgba(148, 163, 184, 0.18);
  border-radius: 18px;
  padding: 22px 24px;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.55);
}

/* 5Ô∏è‚É£ NADPISY KARET ‚Äì LED MIMO TEXT */
.card-header {
  position: relative;
  padding-left: 18px;
}

.card-header::before {
  content: "";
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #22c55e;
  box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
}
/* =========================
   DANGEROUS ACTION BUTTON
========================= */
.btn-danger{
  background: transparent;
  color: #ef4444;               /* red-500 */
  border: 1px solid #ef4444;
  border-radius: 999px;
  padding: 10px 18px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all .2s ease;
}

.btn-danger:hover{
  background: rgba(239,68,68,0.12);
  box-shadow:
    0 0 0 1px rgba(239,68,68,0.4),
    0 0 18px rgba(239,68,68,0.35);
}

.btn-danger:disabled{
  opacity: 0.4;
  cursor: not-allowed;
  box-shadow: none;
}

.table-wrapper {
  max-height: 420px;       /* cca 10 ≈ô√°dk≈Ø */
  overflow-y: auto;
  border-radius: 12px;
}

/* jemn√Ω scrollbar ‚Äì voliteln√© */
.table-wrapper::-webkit-scrollbar {
  width: 8px;
}
.table-wrapper::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
}


</style>
</head>

<body>

<div id="user-bar" style="
  position:fixed;
  top:12px;
  right:16px;
  z-index:9999;
  font-size:12px;
  color:#e5e7eb;
  background:rgba(2,6,23,0.85);
  border:1px solid rgba(148,163,184,0.3);
  padding:6px 12px;
  border-radius:999px;
  display:none;
">
  P≈ôihl√°≈°en: <span id="user-email"></span>
  ¬∑ <a href="#" id="logout" style="color:#4fa3ff;text-decoration:none;">Odhl√°sit</a>
</div>
  
<div class="admin-wrap">

<!-- HEADER -->
<div class="admin-header">
  <div class="admin-title">AYAS-7 ¬∑ Admin</div>
  <div class="admin-sub">
    √ö≈ôedn√≠ deska ≈ô√≠zen√≠ dru≈æstva ¬∑ dohled ¬∑ audit ¬∑ p≈ôehled
  </div>
</div>

<!-- QUICK ACTIONS -->
<div class="quick-actions">
  <a href="spf.html" class="qa-box qa-spf">
    <div class="qa-led"></div>
    <div class="qa-title">SPF ‚Äì s√≠≈•ov√Ω provizn√≠ fond</div>
    <div class="qa-desc">≈ò√≠zen√≠ obdob√≠, v√Ωpoƒçty a rozdƒõlen√≠ CRX</div>
    <div class="qa-cta">‚Üí P≈ôej√≠t na SPF ≈ô√≠zen√≠</div>
  </a>

  <a href="member-intelligence.html" class="qa-box qa-member">
    <div class="qa-led"></div>
    <div class="qa-title">ƒålensk√° karta ‚Äì intern√≠ v√Ωjezd</div>
    <div class="qa-desc">Detail ƒçlena, role, historie</div>
    <div class="qa-cta">‚Üí Otev≈ô√≠t p≈ôehled</div>
  </a>

  <a href="audit-print.html" target="_blank" class="qa-box qa-audit">
    <div class="qa-led"></div>
    <div class="qa-title">Audit uzav≈ôen√©ho obdob√≠</div>
    <div class="qa-desc">Ofici√°ln√≠ v√Ωstup dle stanov</div>
    <div class="qa-cta">‚Üí Otev≈ô√≠t audit (PDF)</div>
  </a>
</div>

<!-- STATS -->
<div class="stats">
  <div class="stat">
    <div class="stat-title">ƒålenov√©</div>
    <div class="stat-value" id="stat-members">‚Äî</div>
  </div>
  <div class="stat">
    <div class="stat-title">WW-KEY (celkem)</div>
    <div class="stat-value" id="stat-wwkey">‚Äî</div>
  </div>
  <div class="stat">
    <div class="stat-title">CRX (celkem)</div>
    <div class="stat-value" id="stat-crx">‚Äî</div>
  </div>
</div>

<div class="stat">
  <div class="stat-title">CRX v poolu</div>
  <div class="stat-value" id="stat-crx-pool">‚Äî</div>
</div>


<!-- MEMBERS -->
<div class="section">
  <h2>ƒålenov√© dru≈æstva</h2>
  <p>Ofici√°ln√≠ p≈ôehled WW-KEY, CRX, rol√≠ a certifikace.</p>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ƒålen</th>
          <th>WW-KEY</th>
          <th>CRX</th>
          <th>Role</th>
          <th>Certifik√°t</th>
          <th>Detail</th>
        </tr>
      </thead>
      <tbody id="members-table-body">
        <tr>
          <td colspan="6" style="color:#64748b">Naƒç√≠t√°m data‚Ä¶</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


<!-- CERTIFICATION -->
<div class="section">
  <h2>Certifikace ƒçlenstv√≠</h2>
  <p>Potvrzen√≠ p≈ôijet√≠ vkladu a vyd√°n√≠ certifik√°tu WW-KEY.</p>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ƒålen</th>
          <th>Vklad (CZK)</th>
          <th>CZK</th>
          <th>WW-KEY</th>
          <th>Akce</th>
        </tr>
      </thead>
      <tbody id="certification-table-body">
        <tr>
          <td colspan="5" style="color:#64748b">≈Ω√°dn√© ƒçekaj√≠c√≠ certifikace</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- AUDIT -->
<div class="section">
  <h2>Audit uzav≈ôen√©ho obdob√≠</h2>
  <p>Auditn√≠ stopa dle stanov a p≈ô√≠loh dru≈æstva.</p>
  <div class="audit-box">
    <div>
      <div id="audit-closed-at">Datum uz√°vƒõrky: ‚Äî</div>
      <div id="audit-hash">Audit hash: ‚Äî</div>
    </div>
<!-- OBDOB√ç ‚Äì UZ√ÅVƒöRKA -->
<div class="section">
  <h2>Uz√°vƒõrka obdob√≠</h2>
  <p>
    Form√°ln√≠ uzav≈ôen√≠ obdob√≠ bez rozdƒõlen√≠ prost≈ôedk≈Ø.
    Tento krok je auditn√≠ a nevratn√Ω.
  </p>

  <div class="audit-box">
    <div>
      <div id="period-label">Obdob√≠: ‚Äî</div>
      <div id="period-status">Stav: ‚Äî</div>
    </div>

    <button
  id="close-period-btn"
  class="btn btn-danger"
  onclick="closePeriod()"
>
  Uzav≈ô√≠t obdob√≠
</button>

  </div>
</div>

    <a href="audit-print.html" target="_blank" class="btn btn-green">
      Otev≈ô√≠t audit (PDF)
    </a>
  </div>
</div>

<div class="footer">
  AYAS-7 ¬∑ Admin = dohled ¬∑ SPF = samostatn√Ω modul ¬∑ audit-ready
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://azfrniqqtetoqploxwgq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU";

const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

async function loadStats(){

  const { data, error } = await sb
    .from("v_admin_stats")
    .select("*")
    .single();

  if(error){
    console.error("Stats error", error);
    return;
  }

  document.getElementById("stat-members").innerText =
    data?.total_members ?? 0;

  document.getElementById("stat-wwkey").innerText =
    Number(data?.total_wwkey || 0).toFixed(2);

  document.getElementById("stat-crx").innerText =
    Number(data?.crx_total || 0).toFixed(2);

  console.log("STATS:", data);
}

/* =========================
   STATISTIKY
========================= */
async function loadCrxPool(){

  const { data: periodRow } = await sb
    .from("spf_periods_ui")
    .select("period")
    .eq("status", "closed")   // üî• ZP√ÅTKY NA CLOSED
    .not("period", "ilike", "%TEST%")
    .order("period", { ascending: false })
    .limit(1)
    .single();

  if(!periodRow){
    console.warn("No closed period");
    return;
  }

  const { data } = await sb
    .from("v_crx_period_with_pool")
    .select("total_crx")
    .eq("period", periodRow.period)
    .maybeSingle();

  document.getElementById("stat-crx-pool").innerText =
    Number(data?.total_crx || 0).toFixed(2);

  console.log("CRX from CLOSED:", periodRow.period);
}

/* =========================
   ƒåLENOV√â
========================= */
async function loadMembers(){
  const { data, error } = await sb
    .from("v_admin_members")
    .select("*")
    .order("email");

  if(error){
    console.error("Members error", error);
    return;
  }

  const tbody = document.getElementById("members-table-body");
  if(!tbody) return;

  tbody.innerHTML = "";

  data.forEach(m => {
    tbody.innerHTML += `
      <tr>
        <td>${m.email}</td>
        <td>${m.wwkey_total ?? 0}</td>
        <td>${m.crx_total ?? 0}</td>
        <td>${m.role ?? "‚Äî"}</td>
        <td>${m.has_certificate ? "‚úî" : "‚Äî"}</td>
        <td>
          <a href="member-intelligence.html?member=${m.member_uuid}">
            detail ‚Üí
          </a>
        </td>
      </tr>
    `;
  });
}

/* =========================
   CERTIFIK√ÅTY ‚Äì POUZE INFO
========================= */
async function loadCertificates(){
  const { data, error } = await sb
    .from("v_admin_certificates")
    .select("*")
    .order("issued_at", { ascending: false });

  if(error){
    console.error("Certificates error", error);
    return;
  }

  const tbody = document.getElementById("certification-table-body");
  if(!tbody) return;

  tbody.innerHTML = "";

  if(!data.length){
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="color:#64748b">
          ≈Ω√°dn√© certifik√°ty
        </td>
      </tr>`;
    return;
  }

  data.forEach(c => {
    tbody.innerHTML += `
      <tr>
        <td>${c.member_email}</td>
        <td>${c.full_name ?? "‚Äî"}</td>
        <td>${Number(c.deposit_amount).toLocaleString("cs-CZ")}</td>
        <td>${c.ww_key_amount}</td>
        <td>${new Date(c.issued_at).toLocaleString("cs-CZ")}</td>
        <td>potvrzeno (platba)</td>
      </tr>
    `;
  });
}

/* =========================
   AUDIT
========================= */
async function loadAudit(){
  const { data, error } = await sb
    .from("v_admin_last_audit")
    .select("*")
    .single();

  if(error){
    console.warn("Audit not found");
    return;
  }

  const closedEl = document.getElementById("audit-closed-at");
  const hashEl   = document.getElementById("audit-hash");

  if(closedEl){
    closedEl.innerText =
      "Uzav≈ôeno: " + new Date(data.closed_at).toLocaleString("cs-CZ");
  }

  if(hashEl){
    hashEl.innerText =
      "Audit hash: " + (data.audit_hash ?? "‚Äî zat√≠m nevygenerov√°n");
  }
}

/* =========================
   CERTIFIKACE ‚Äì AKCE
========================= */
async function confirmCertification(memberId){
  if(!confirm("Potvrdit certifikaci?")) return;

  const res = await fetch(
    "/functions/v1/issue-certificate",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ member_id: memberId })
    }
  );

  if(!res.ok){
    alert("Chyba p≈ôi certifikaci");
    return;
  }

  await loadMembers();
  await loadCertificationQueue();
}
/* =========================
   OBDOB√ç ‚Äì NAƒåTEN√ç STAVU
========================= */
async function loadCurrentPeriod(){

  // üî• vezmi aktivn√≠ (draft) obdob√≠
  const { data, error } = await sb
    .from("spf_periods_ui")
    .select("id, period, status")
    .eq("status", "draft")
    .order("created_at", { ascending: false })
    .limit(1)
    .maybeSingle();

  if(error){
    console.warn("Period error", error);
    return;
  }

  if(!data){
    console.warn("No active (draft) period found");
    return;
  }

  document.getElementById("period-label").innerText =
    "Obdob√≠: " + data.period;

  document.getElementById("period-status").innerText =
    "Stav: " + data.status;

  const btn = document.getElementById("close-period-btn");

  if(btn){
    if(data.status !== "draft"){
      btn.disabled = true;
      btn.innerText = "Obdob√≠ je uzav≈ôeno";
    } else {
      btn.disabled = false;
      btn.innerText = "Uzav≈ô√≠t obdob√≠";
    }
  }

  // ulo≈æ√≠me ID
  window.__CURRENT_PERIOD_ID__ = data.id;

  console.log("ACTIVE PERIOD:", data.period);
}

/* =========================
   OBDOB√ç ‚Äì UZAV≈òEN√ç
========================= */
async function closePeriod(){
  if(!confirm(
    "Opravdu uzav≈ô√≠t obdob√≠?\n\n" +
    "Neprobƒõhne ≈æ√°dn√© rozdƒõlen√≠.\n" +
    "Krok je auditn√≠ a nevratn√Ω."
  )) return;

  const periodId = window.__CURRENT_PERIOD_ID__;
  if(!periodId){
    alert("Nelze urƒçit aktivn√≠ obdob√≠.");
    return;
  }

  const res = await fetch(
    "https://azfrniqqtetoqploxwgq.supabase.co/functions/v1/close-period",
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ period: periodId })
    }
  );

  if(!res.ok){
    alert("Chyba p≈ôi uzav≈ôen√≠ obdob√≠");
    return;
  }

  alert("Obdob√≠ bylo auditnƒõ uzav≈ôeno.");
  await loadCurrentPeriod();
}

/* =========================
   INIT
========================= */
document.addEventListener("DOMContentLoaded", async () => {
  await loadStats();        // üî• TOTO TI CHYB√ç
  await loadCrxPool();
  await loadMembers();
  await loadCertificates();
  await loadAudit();
  await loadCurrentPeriod();
});
</script>


</body>
</html>
