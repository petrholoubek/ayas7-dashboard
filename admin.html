<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>AYAS-7 · Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="module" src="./assets/js/gate.js"></script>
  
<!-- FAVICON / PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/ayas7-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/ayas7-512.png">
  <link rel="apple-touch-icon" href="/ayas7-192.png">
  <meta name="theme-color" content="#020617">
<style>
:root{
  --bg:#020617;
  --panel:#0b1222;
  --panel-soft:#0f172acc;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;

  --green:#22c55e;
  --blue:#38bdf8;
  --yellow:#facc15;
}

*{box-sizing:border-box}

html,body{
  margin:0;
  padding:0;
  background:radial-gradient(1200px 600px at top,#020617,#000);
  color:var(--text);
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
}

a{color:inherit;text-decoration:none}

/* === WRAPPER === */
.admin-wrap{
  max-width:1200px;
  margin:0 auto;
  padding:28px 20px 40px;
  display:flex;
  flex-direction:column;
  gap:26px;
}

/* === HEADER === */
.admin-header{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.admin-title{
  font-size:26px;
  font-weight:600;
  letter-spacing:.04em;
}

.admin-sub{
  font-size:13px;
  color:var(--muted);
}

/* === QUICK ACTIONS === */
.quick-actions{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:18px;
}

.qa-box{
  position:relative;
  background:linear-gradient(180deg,#0b1222,#020617);
  border:1px solid var(--border);
  border-radius:20px;
  padding:22px;
  transition:transform .25s ease, box-shadow .25s ease;
}

.qa-box:hover{
  transform:translateY(-3px);
  box-shadow:0 18px 40px rgba(0,0,0,.45);
}

.qa-led{
  position:absolute;
  top:16px;
  right:16px;
  width:10px;
  height:10px;
  border-radius:50%;
}

.qa-title{
  font-size:15px;
  font-weight:600;
  margin-bottom:6px;
}

.qa-desc{
  font-size:12px;
  color:var(--muted);
  margin-bottom:14px;
}

.qa-cta{
  font-size:12px;
  font-weight:600;
  letter-spacing:.02em;
}

/* COLORS */
.qa-spf{border-color:var(--yellow)}
.qa-spf .qa-led{background:var(--yellow);box-shadow:0 0 14px var(--yellow)}

.qa-member{border-color:var(--blue)}
.qa-member .qa-led{background:var(--blue);box-shadow:0 0 14px var(--blue)}

.qa-audit{border-color:var(--green)}
.qa-audit .qa-led{background:var(--green);box-shadow:0 0 14px var(--green)}

/* === STATUS PANELS === */
.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
}

.stat{
  position:relative;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px 20px;
}

.stat::after{
  content:"";
  position:absolute;
  top:14px;
  right:14px;
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--green);
  box-shadow:0 0 12px var(--green);
}

.stat-title{
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}

.stat-value{
  font-size:22px;
  font-weight:600;
}

/* === SECTIONS === */
.section{
  background:var(--panel-soft);
  border:1px solid var(--border);
  border-radius:22px;
  padding:22px;
}

.section h2{
  margin:0 0 6px;
  font-size:16px;
}

.section p{
  margin:0 0 14px;
  font-size:12px;
  color:var(--muted);
}

/* === TABLE === */
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:left;
}

th{
  font-size:11px;
  color:var(--muted);
}

/* === CERTIFICATION BUTTON === */
.btn{
  display:inline-block;
  padding:8px 14px;
  font-size:12px;
  border-radius:999px;
  border:1px solid var(--border);
}

.btn-green{
  border-color:var(--green);
  color:var(--green);
}

/* === AUDIT PANEL === */
.audit-box{
  border:1px dashed var(--blue);
  border-radius:16px;
  padding:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* === FOOTER === */
.footer{
  text-align:center;
  font-size:11px;
  color:var(--muted);
  margin-top:30px;
}

/* =========================================================
   AYAS-7 ADMIN – JEDNOTNÉ POZADÍ (FINÁL)
   ========================================================= */

/* 1️⃣ CELÁ STRÁNKA – JEDNO POZADÍ */
html, body {
  margin: 0;
  padding: 0;
  min-height: 100%;
  background:
    radial-gradient(
      1200px 600px at 20% -10%,
      #0b1220 0%,
      #020617 60%
    );
  color: #e5e7eb;
  font-family: "Segoe UI", Tahoma, Verdana, sans-serif;
}

/* 2️⃣ HLAVNÍ KONTEJNER ADMINU */
.admin-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 48px 24px 64px;
}

/* 3️⃣ SEKCE JSOU PRŮHLEDNÉ (NELEPÍ SE) */
.section {
  background: transparent;
  margin-bottom: 32px;
}

/* 4️⃣ KARTY / BOXY – JEDINÉ MÍSTO S POZADÍM */
.card {
  background: linear-gradient(
    180deg,
    rgba(15, 23, 42, 0.95),
    rgba(2, 6, 23, 0.95)
  );
  border: 1px solid rgba(148, 163, 184, 0.18);
  border-radius: 18px;
  padding: 22px 24px;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.55);
}

/* 5️⃣ NADPISY KARET – LED MIMO TEXT */
.card-header {
  position: relative;
  padding-left: 18px;
}

.card-header::before {
  content: "";
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #22c55e;
  box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
}
/* =========================
   DANGEROUS ACTION BUTTON
========================= */
.btn-danger{
  background: transparent;
  color: #ef4444;               /* red-500 */
  border: 1px solid #ef4444;
  border-radius: 999px;
  padding: 10px 18px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all .2s ease;
}

.btn-danger:hover{
  background: rgba(239,68,68,0.12);
  box-shadow:
    0 0 0 1px rgba(239,68,68,0.4),
    0 0 18px rgba(239,68,68,0.35);
}

.btn-danger:disabled{
  opacity: 0.4;
  cursor: not-allowed;
  box-shadow: none;
}

.table-wrapper {
  max-height: 420px;       /* cca 10 řádků */
  overflow-y: auto;
  border-radius: 12px;
}

/* jemný scrollbar – volitelné */
.table-wrapper::-webkit-scrollbar {
  width: 8px;
}
.table-wrapper::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
}


</style>
</head>

<body>

<div id="user-bar" style="
  position:fixed;
  top:12px;
  right:16px;
  z-index:9999;
  font-size:12px;
  color:#e5e7eb;
  background:rgba(2,6,23,0.85);
  border:1px solid rgba(148,163,184,0.3);
  padding:6px 12px;
  border-radius:999px;
  display:none;
">
  Přihlášen: <span id="user-email"></span>
  · <a href="#" id="logout" style="color:#4fa3ff;text-decoration:none;">Odhlásit</a>
</div>
  
<div class="admin-wrap">

<!-- HEADER -->
<div class="admin-header">
  <div class="admin-title">AYAS-7 · Admin</div>
  <div class="admin-sub">
    Úřední deska řízení družstva · dohled · audit · přehled
  </div>
</div>

<!-- QUICK ACTIONS -->
<div class="quick-actions">
  <a href="spf.html" class="qa-box qa-spf">
    <div class="qa-led"></div>
    <div class="qa-title">SPF – síťový provizní fond</div>
    <div class="qa-desc">Řízení období, výpočty a rozdělení CRX</div>
    <div class="qa-cta">→ Přejít na SPF řízení</div>
  </a>

  <a href="member-intelligence.html" class="qa-box qa-member">
    <div class="qa-led"></div>
    <div class="qa-title">Členská karta – interní výjezd</div>
    <div class="qa-desc">Detail člena, role, historie</div>
    <div class="qa-cta">→ Otevřít přehled</div>
  </a>

  <a href="audit-print.html" target="_blank" class="qa-box qa-audit">
    <div class="qa-led"></div>
    <div class="qa-title">Audit uzavřeného období</div>
    <div class="qa-desc">Oficiální výstup dle stanov</div>
    <div class="qa-cta">→ Otevřít audit (PDF)</div>
  </a>
</div>

<!-- STATS -->
<div class="stats">
  <div class="stat">
    <div class="stat-title">Členové</div>
    <div class="stat-value" id="stat-members">—</div>
  </div>
  <div class="stat">
    <div class="stat-title">WW-KEY (celkem)</div>
    <div class="stat-value" id="stat-wwkey">—</div>
  </div>
  <div class="stat">
    <div class="stat-title">CRX (celkem)</div>
    <div class="stat-value" id="stat-crx">—</div>
  </div>
</div>

<!-- MEMBERS -->
<div class="section">
  <h2>Členové družstva</h2>
  <p>Oficiální přehled WW-KEY, CRX, rolí a certifikace.</p>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Člen</th>
          <th>WW-KEY</th>
          <th>CRX</th>
          <th>Role</th>
          <th>Certifikát</th>
          <th>Detail</th>
        </tr>
      </thead>
      <tbody id="members-table-body">
        <tr>
          <td colspan="6" style="color:#64748b">Načítám data…</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


<!-- CERTIFICATION -->
<div class="section">
  <h2>Certifikace členství</h2>
  <p>Potvrzení přijetí vkladu a vydání certifikátu WW-KEY.</p>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Člen</th>
          <th>Vklad (CZK)</th>
          <th>WW-KEY</th>
          <th>Stav</th>
          <th>Akce</th>
        </tr>
      </thead>
      <tbody id="certification-table-body">
        <tr>
          <td colspan="5" style="color:#64748b">Žádné čekající certifikace</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- AUDIT -->
<div class="section">
  <h2>Audit uzavřeného období</h2>
  <p>Auditní stopa dle stanov a příloh družstva.</p>
  <div class="audit-box">
    <div>
      <div id="audit-closed-at">Datum uzávěrky: —</div>
      <div id="audit-hash">Audit hash: —</div>
    </div>
<!-- OBDOBÍ – UZÁVĚRKA -->
<div class="section">
  <h2>Uzávěrka období</h2>
  <p>
    Formální uzavření období bez rozdělení prostředků.
    Tento krok je auditní a nevratný.
  </p>

  <div class="audit-box">
    <div>
      <div id="period-label">Období: —</div>
      <div id="period-status">Stav: —</div>
    </div>

    <button
  id="close-period-btn"
  class="btn btn-danger"
  onclick="closePeriod()"
>
  Uzavřít období
</button>

  </div>
</div>

    <a href="audit-print.html" target="_blank" class="btn btn-green">
      Otevřít audit (PDF)
    </a>
  </div>
</div>

<div class="footer">
  AYAS-7 · Admin = dohled · SPF = samostatný modul · audit-ready
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://azfrniqqtetoqploxwgq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU";

const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* =========================
   STATISTIKY
========================= */
async function loadStats(){
  const { data, error } = await sb
    .from("v_admin_stats")
    .select("*")
    .single();

  if(error){
    console.error("Stats error", error);
    return;
  }

  document.getElementById("stat-members").innerText =
    data.members_count ?? 0;

  document.getElementById("stat-wwkey").innerText =
    data.wwkey_total ?? 0;

  document.getElementById("stat-crx").innerText =
    data.crx_total ?? 0;
}

/* =========================
   ČLENOVÉ
========================= */
async function loadMembers(){
  const { data, error } = await sb
    .from("v_admin_members")
    .select("*")
    .order("email");

  if(error){
    console.error("Members error", error);
    return;
  }

  const tbody = document.getElementById("members-table-body");
  if(!tbody) return;

  tbody.innerHTML = "";

  data.forEach(m => {
    tbody.innerHTML += `
      <tr>
        <td>${m.email}</td>
        <td>${m.wwkey_total ?? 0}</td>
        <td>${m.crx_total ?? 0}</td>
        <td>${m.role ?? "—"}</td>
        <td>${m.has_certificate ? "✔" : "—"}</td>
        <td>
          <a href="member-intelligence.html?member=${m.member_uuid}">
            detail →
          </a>
        </td>
      </tr>
    `;
  });
}

/* =========================
   CERTIFIKÁTY – POUZE INFO
========================= */
async function loadCertificates(){
  const { data, error } = await sb
    .from("v_admin_certificates")
    .select("*")
    .order("issued_at", { ascending: false });

  if(error){
    console.error("Certificates error", error);
    return;
  }

  const tbody = document.getElementById("certification-table-body");
  if(!tbody) return;

  tbody.innerHTML = "";

  if(!data.length){
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="color:#64748b">
          Žádné certifikáty
        </td>
      </tr>`;
    return;
  }

  data.forEach(c => {
    tbody.innerHTML += `
      <tr>
        <td>${c.member_email}</td>
        <td>${c.full_name ?? "—"}</td>
        <td>${Number(c.deposit_amount).toLocaleString("cs-CZ")}</td>
        <td>${c.ww_key_amount}</td>
        <td>${new Date(c.issued_at).toLocaleString("cs-CZ")}</td>
        <td>potvrzeno (platba)</td>
      </tr>
    `;
  });
}

/* =========================
   AUDIT
========================= */
async function loadAudit(){
  const { data, error } = await sb
    .from("v_admin_last_audit")
    .select("*")
    .single();

  if(error){
    console.warn("Audit not found");
    return;
  }

  const closedEl = document.getElementById("audit-closed-at");
  const hashEl   = document.getElementById("audit-hash");

  if(closedEl){
    closedEl.innerText =
      "Uzavřeno: " + new Date(data.closed_at).toLocaleString("cs-CZ");
  }

  if(hashEl){
    hashEl.innerText =
      "Audit hash: " + (data.audit_hash ?? "— zatím nevygenerován");
  }
}

/* =========================
   CERTIFIKACE – AKCE
========================= */
async function confirmCertification(memberId){
  if(!confirm("Potvrdit certifikaci?")) return;

  const res = await fetch(
    "/functions/v1/issue-certificate",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ member_id: memberId })
    }
  );

  if(!res.ok){
    alert("Chyba při certifikaci");
    return;
  }

  await loadMembers();
  await loadCertificationQueue();
}
/* =========================
   OBDOBÍ – NAČTENÍ STAVU
========================= */
async function loadCurrentPeriod(){
  const { data, error } = await sb
    .from("spf_periods_ui")
    .select("id, period, status")
    .order("created_at", { ascending: false })
    .limit(1)
    .single();

  if(error){
    console.warn("Period not found");
    return;
  }

  document.getElementById("period-label").innerText =
    "Období: " + data.period;

  document.getElementById("period-status").innerText =
    "Stav: " + data.status;

  // pokud je už uzavřeno, zakážeme tlačítko
  if(data.status !== "draft"){
    const btn = document.getElementById("close-period-btn");
    btn.disabled = true;
    btn.innerText = "Období je uzavřeno";
  }

  // uložíme si ID pro uzávěrku
  window.__CURRENT_PERIOD_ID__ = data.id;
}
/* =========================
   OBDOBÍ – UZAVŘENÍ
========================= */
async function closePeriod(){
  if(!confirm(
    "Opravdu uzavřít období?\n\n" +
    "Neproběhne žádné rozdělení.\n" +
    "Krok je auditní a nevratný."
  )) return;

  const periodId = window.__CURRENT_PERIOD_ID__;
  if(!periodId){
    alert("Nelze určit aktivní období.");
    return;
  }

  const res = await fetch(
    "https://azfrniqqtetoqploxwgq.supabase.co/functions/v1/close-period",
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ period: periodId })
    }
  );

  if(!res.ok){
    alert("Chyba při uzavření období");
    return;
  }

  alert("Období bylo auditně uzavřeno.");
  await loadCurrentPeriod();
}

/* =========================
   INIT
========================= */
document.addEventListener("DOMContentLoaded", async () => {
  await loadStats();
  await loadMembers();
  await loadCertificates();
  await loadAudit();
  await loadCurrentPeriod();

});
</script>


</body>
</html>
