<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<title>AYAS-7 ‚Ä¢ Admin Vel√≠n</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
html,body{
  margin:0;padding:0;height:100%;
  background:#020617;color:#e5e7eb;
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
}
header{
  padding:18px 22px;
  border-bottom:1px solid rgba(148,163,184,.25);
  background:linear-gradient(180deg,#020617,#030712);
}
.header-line{
  display:flex;align-items:center;gap:10px;
}
.led{
  width:10px;height:10px;border-radius:50%;
  background:#22c55e;box-shadow:0 0 12px #22c55e;
}
h1{margin:6px 0 2px;font-size:22px}
.sub{font-size:12px;opacity:.7}

main{padding:20px;max-width:1300px;margin:auto}

.card{
  background:#0f172a;
  border:1px solid rgba(148,163,184,.25);
  border-radius:14px;
  padding:16px;
  margin-bottom:18px;
}

table{
  width:100%;border-collapse:collapse;font-size:13px;
}
th,td{
  padding:8px;border-bottom:1px solid rgba(148,163,184,.15);
}
th{text-align:left;color:#94a3b8;font-weight:600}
button{
  background:#1f2937;color:#e5e7eb;
  border:1px solid rgba(148,163,184,.4);
  border-radius:999px;
  padding:5px 12px;
  cursor:pointer;font-size:12px;
}
button:hover{background:#334155}

.promo-box{
  font-size:11px;color:#a5b4fc;margin-top:6px
}
</style>
</head>

<body>

<header>
  <div class="header-line">
    <span class="led"></span>
    <strong>NEXT GENERATION</strong>
  </div>
  <h1>AYAS-7 ENGINE</h1>
  <div class="sub">Administraƒçn√≠ & rozhodovac√≠ procesy ¬∑ intern√≠ rozhran√≠</div>
</header>

<main>

<!-- OBCHODN√çCI -->
<div class="card">
<h2>Obchodn√≠ z√°stupci</h2>
<table id="agentsTable"></table>
</div>

<!-- ƒåLENOV√â -->
<div class="card">
<h2>ƒålenov√©</h2>
<table id="membersTable"></table>
</div>

<!-- PDF -->
<div class="card">
<h2>Auditn√≠ v√Ωstupy</h2>
<button onclick="generatePDF()">üìÑ Generovat auditn√≠ PDF</button>
</div>

</main>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>

const SUPABASE_URL = "https://hurayrwshmsvsylhwlbj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1cmF5cndzaG1zdnN5bGh3bGJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMTk4MzEsImV4cCI6MjA3OTc5NTgzMX0.Q0KpZX_Dln9_9OwZcCty-bbyw8drX84ax098Uy03VUI";


let DATA = { agents:[], members:[], promo:[] };

async function loadAll(){
  const res = await fetch(SUPABASE_URL+"/functions/v1/smart-endpoint",{
    headers:{ "Authorization":"Bearer "+SUPABASE_ANON_KEY }
  });
  DATA = await res.json();
  renderAgents();
  renderMembers();
}

function renderAgents(){
  let html = "<tr><th>Jm√©no</th><th>Status</th><th>Promo</th></tr>";
  DATA.agents.forEach(a=>{
    const promos = DATA.promo.filter(p=>p.agent_id===a.id);
    html += `
    <tr>
      <td>${a.name}</td>
      <td>${a.status}</td>
      <td>
        <button onclick="generatePromo(${a.id})">üéü Promo</button>
        <div class="promo-box">
          ${promos.length ? promos.map(p=>"‚Ä¢ "+p.code).join("<br>") : "‚Äî ≈æ√°dn√© promo ‚Äî"}
        </div>
      </td>
    </tr>`;
  });
  document.getElementById("agentsTable").innerHTML = html;
}

function renderMembers(){
  let html = "<tr><th>Jm√©no</th><th>Vklad</th><th>Status</th><th>Akce</th></tr>";
  DATA.members.forEach(m=>{
    html += `
    <tr>
      <td>${m.name}</td>
      <td>${m.deposit}</td>
      <td>${m.status}</td>
      <td>
        ${m.status==="pending"?
          `<button onclick="approveMember(${m.id})">Schv√°lit</button>`:"‚Äî"}
      </td>
    </tr>`;
  });
  document.getElementById("membersTable").innerHTML = html;
}

async function approveMember(id){
  await fetch(SUPABASE_URL+"/functions/v1/approve-member",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+SUPABASE_ANON_KEY
    },
    body:JSON.stringify({ member_id:id })
  });
  loadAll();
}

async function generatePromo(agent_id){
  const res = await fetch(SUPABASE_URL+"/functions/v1/generate-promo",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ agent_id })
  });
  const data = await res.json();
  alert("Promo k√≥d: "+data.code);
  loadAll();
}

function generatePDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.setFontSize(16);
  pdf.text("AYAS-7 ENGINE ‚Äì AUDIT REPORT", 14, 16);
  pdf.setFontSize(10);
  pdf.text("Vygenerov√°no: "+new Date().toLocaleString(),14,24);

  let y = 36;
  pdf.text("ƒålenov√©:",14,y); y+=6;

  DATA.members.forEach(m=>{
    pdf.text(
      `‚Ä¢ ${m.name} | vklad: ${m.deposit} | status: ${m.status}`,
      14,y
    );
    y+=5;
  });

  pdf.save("AYAS7_AUDIT.pdf");
}

loadAll();
</script>

</body>
</html>
