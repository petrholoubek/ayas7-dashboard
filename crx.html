<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<title>AYAS-7 · Member Bank Account</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- FAVICON / PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/ayas7-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/ayas7-512.png">
  <link rel="apple-touch-icon" href="/ayas7-192.png">
  <meta name="theme-color" content="#020617">

<style>
:root{
  --bg:#020617;
  --panel:#0b1222;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;

  --accent:#22c55e;   /* bankovní zelená */
  --accent-soft:rgba(34,197,94,0.15);
}

*{box-sizing:border-box}

html,body{
  margin:0;
  padding:0;
  min-height:100%;
  background:radial-gradient(1200px 600px at 50% -10%, #0b1220, #020617);
  font-family:"Segoe UI", Tahoma, Verdana, sans-serif;
  color:var(--text);
}

main{
  max-width:880px;
  margin:48px auto 120px;
  padding:0 18px;
}

/* ================= HEADER ================= */
.header{margin-bottom:32px}

.kicker{
  display:flex;align-items:center;gap:8px;
  font-size:11px;letter-spacing:.18em;
  text-transform:uppercase;color:var(--muted);
}

.dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--accent);
  box-shadow:0 0 10px var(--accent);
}

.title{margin-top:10px;font-size:26px;font-weight:700}
.subtitle{margin-top:4px;font-size:13px;color:var(--muted)}

/* ================= CARD BASE ================= */
.card{
  background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(2,6,23,.96));
  border:1px solid var(--border);
  border-radius:18px;
  padding:22px 24px 26px;
  margin-top:18px;
}

/* ================= BANK BALANCE ================= */
.balance{
  font-size:54px;
  font-weight:800;
  letter-spacing:.02em;
  margin:6px 0 8px;
}

.meta{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  color:var(--muted);
}

/* ================= GRAPH ================= */
.graph{
  height:160px;
  margin-top:16px;
  border-top:1px solid rgba(148,163,184,.15);
  padding-top:12px;
}

canvas{width:100%;height:100%}

/* ================= INFO TABLE ================= */
.row{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  padding:8px 0;
  border-bottom:1px dashed rgba(255,255,255,.06);
}

/* ================= MANUAL LOAD ================= */
.manual{
  display:flex;
  gap:10px;
}

.manual input{
  flex:1;
  padding:10px;
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
  border-radius:10px;
}

button{
  background:var(--accent);
  color:#000;
  border:none;
  padding:10px 16px;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}

footer{
  margin-top:42px;
  font-size:11px;
  letter-spacing:.16em;
  text-transform:uppercase;
  color:#64748b;
}

.balance-main{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin-bottom:24px;
}

.crx-value{
  font-size:64px;
  font-weight:800;
}

.wwkey-value{
  font-size:28px;
  font-weight:700;
  color:#38bdf8;
}

.yield-value{
  font-size:22px;
  font-weight:700;
  color:#22c55e;
}

.crx-label,
.wwkey-label,
.yield-label{
  font-size:12px;
  color:#94a3b8;
  margin-top:4px;
}

.btn-cert{
  display:inline-block;
  padding:10px 18px;
  border-radius:999px;
  border:1px solid #22c55e;
  color:#22c55e;
  font-size:13px;
  text-decoration:none;
  transition:.2s;
}

.btn-cert:hover{
  background:rgba(34,197,94,.12);
  box-shadow:0 0 12px rgba(34,197,94,.35);
}


</style>
</head>

<body>

<main>

<!-- HEADER -->
<section class="header">
  <div class="kicker"><span class="dot"></span>Member Account · Secure View</div>
  <div class="title">AYAS-7 · Osobní účet</div>
  <div id="memberName" class="subtitle">Načítám data člena…</div>
</section>

<!-- MANUAL LOAD (ADMIN / TEST) -->
<section class="card">
  <div class="manual">
    <input id="manualInput" placeholder="Zadej e-mail nebo UUID člena" />
    <button onclick="loadManual()">Načíst</button>
  </div>
</section>

<!-- MAIN BALANCE -->
<section class="card">

  <div class="balance-main">

    <div class="balance-crx">
      <div id="crxTotal" class="crx-value">0 CRX</div>
      <div class="crx-label">Tokenový zůstatek</div>
    </div>

    <div class="balance-wwkey">
      <div id="wwkeyTotal" class="wwkey-value">0</div>
      <div class="wwkey-label">WW-KEY podíl</div>
    </div>

    <div class="balance-yield">
      <div id="yieldPct" class="yield-value">0.00 %</div>
      <div class="yield-label">Podíl na výnosu</div>
    </div>

  </div>

  <div class="graph">
    <canvas id="chart"></canvas>
  </div>

</section>

<!-- ACCOUNT INFO -->
<section class="card">
  <div class="row"><span>Status účtu</span><span id="status">—</span></div>
  <div class="row"><span>Poslední snapshot</span><span id="snapshot">—</span></div>
  <div class="row"><span>Member ID</span><span id="memberId">—</span></div>

<div style="margin-top:18px">
  <a id="certLink"
     class="btn-cert"
     href="#"
     target="_blank">
     Stáhnout certifikát WW-KEY
  </a>
</div>

</section>

<footer>AYAS‑7 · Digital Cooperative Banking</footer>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://azfrniqqtetoqploxwgq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= RENDER ================= */

async function renderMember(d){
  console.log("RENDER:", d);

  memberName.innerText = d.full_name ?? d.email;

  crxTotal.innerText =
    Number(d.crx_total ?? 0).toLocaleString("cs-CZ") + " CRX";

  wwkeyTotal.innerText =
    Number(d.wwkey_total ?? 0).toLocaleString("cs-CZ");

  yieldPct.innerText =
    Number(d.yield_percent ?? 0).toFixed(2) + " %";

  status.innerText   = d.status ?? "—";
  snapshot.innerText = new Date(d.last_snapshot_at).toLocaleString("cs-CZ");
  memberId.innerText = d.member_uuid;

  /* ===============================
     NAJDI account_id VE v_admin_members
  =============================== */
  const { data: admin, error: adminErr } = await sb
    .from("v_admin_members")
    .select("account_id")
    .eq("member_uuid", d.member_uuid)
    .maybeSingle();

  console.log("ADMIN:", admin, adminErr);

  let certUid = null;

  /* ===============================
     NAJDI CERTIFIKÁT
  =============================== */
  if (admin?.account_id) {
    const { data: cert, error: certErr } = await sb
      .from("member_certificates")
      .select("certificate_uid")
      .eq("account_id", admin.account_id)
      .limit(1)
      .maybeSingle();

    console.log("CERT:", cert, certErr);

    certUid = cert?.certificate_uid ?? null;
  }

  /* ===============================
     NASTAV TLAČÍTKO
  =============================== */
  const certLink = document.getElementById("certLink");

  if (certLink && certUid) {
    certLink.href = "certificate.html?uid=" + certUid;
    certLink.style.opacity = "1";
    certLink.style.pointerEvents = "auto";
  } else if (certLink) {
    certLink.href = "#";
    certLink.style.opacity = "0.4";
    certLink.style.pointerEvents = "none";
  }

  renderChart([]);
}

/* ================= LOAD MANUAL ================= */

async function loadManual(){
  console.log("LOAD MANUAL START");

  const val = manualInput.value.trim();
  if(!val){
    alert("Zadej e-mail nebo UUID");
    return;
  }

  let query = sb.from("v_member_account").select("*");

  if(val.includes("@")){
    query = query.ilike("email", val);
  }else{
    query = query.eq("member_uuid", val);
  }

  const { data, error } = await query.limit(1);

  console.log("SUPABASE RESULT:", data, error);

  if(error){
    alert("Chyba DB: " + error.message);
    return;
  }

  if(!data || !data.length){
    alert("Člen nenalezen.");
    return;
  }

  renderMember(data[0]);
}

/* ================= INIT ================= */

document.querySelector("button").addEventListener("click", loadManual);
</script>

<script>
let chartInstance = null;

function renderChart(history){
  const ctx = document.getElementById("chart");
  if(!ctx) return;

  // pokud není historie, vytvoříme jemnou rovnou křivku
  if(!history || !history.length){
    history = Array.from({length: 30}, (_, i) => 100 + i * 0.2);
  }

  if(chartInstance){
    chartInstance.destroy();
  }

  chartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels: history.map((_, i) => i),
      datasets: [{
        data: history,
        tension: 0.4,
        borderWidth: 2,
        pointRadius: 0,
        fill: true,
        backgroundColor: "rgba(34,197,94,0.15)"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { display: false },
        y: {
          ticks: { color: "#94a3b8" },
          grid: { color: "rgba(148,163,184,0.1)" }
        }
      }
    }
  });
}
</script>


</body>
</html>
