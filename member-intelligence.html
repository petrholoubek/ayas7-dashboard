<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>WIN.WIN ¬∑ ƒålensk√° karta & Kari√©rn√≠ struktura</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#020617">
<script type="module" src="./assets/js/gate.js"></script>
<!-- FAVICON / PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/ayas7-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/ayas7-512.png">
  <link rel="apple-touch-icon" href="/ayas7-192.png">
  <meta name="theme-color" content="#020617">
<style>
/* ======================================================
   DNA SYST√âMU
====================================================== */
:root{
  --bg:#020617;
  --panel:#0b1120;
  --border:rgba(148,163,184,.25);
  --text:#e5e7eb;
  --muted:#9ca3af;

  --gold:#facc15;
  --teal:#2dd4bf;
  --teal-soft:#0f2f2a;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
  background:radial-gradient(circle at 40% 0%, #0f172a 0%, #020617 65%, #000 100%);
  color:var(--text);
}

/* ======================================================
   LAYOUT
====================================================== */
.page{
  max-width:1400px;
  margin:auto;
  padding:32px 16px 80px;
  display:grid;
  gap:48px;
}

.panel{
  background:radial-gradient(circle at top left,#0b1120,#020617 70%);
  border:1px solid var(--border);
  border-radius:20px;
  padding:22px;
}

.section-head{
  display:flex;
  align-items:center;
  gap:12px;
  font-size:12px;
  letter-spacing:.18em;
  text-transform:uppercase;
  margin-bottom:10px;
}

.led{
  width:10px;height:10px;border-radius:999px;
}
.led-gold{background:var(--gold);box-shadow:0 0 8px var(--gold)}
.led-teal{background:var(--teal);box-shadow:0 0 10px var(--teal)}

p{color:var(--muted);font-size:13px;line-height:1.6}

/* ======================================================
   FORM
====================================================== */
.input, select{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
}

.btn{
  padding:10px 16px;
  border-radius:10px;
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
  cursor:pointer;
}

/* ======================================================
   TABULKY
====================================================== */
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

th,td{
  padding:12px;
  border-bottom:1px solid var(--border);
  text-align:left;
}

tbody tr:nth-child(even){
  background:rgba(255,255,255,.025);
}

/* ======================================================
   OBCHODN√çCI ‚Äì KLIDN√Å PRACOVN√ç Z√ìNA
====================================================== */
.agents-panel{
  background:
    radial-gradient(circle at top left,
      rgba(45,212,191,.12),
      var(--teal-soft) 70%);
  border:1px solid rgba(45,212,191,.35);
}

/* ======================================================
   GRID / RESPONSIVE
====================================================== */
.grid-2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:24px;
}
.grid-3{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:12px;
}

@media(max-width:900px){
  .grid-2,.grid-3{grid-template-columns:1fr}
}

html, body {
  height: 100%;
  margin: 0;
}

body {
  min-height: 100vh;
  background:
    radial-gradient(circle at 40% 0%,
      #0f172a 0%,
      #020617 65%,
      #000 100%);
  background-repeat: no-repeat;
  background-attachment: fixed;
  background-size: cover;
  background-position: center top;

  font-family: "Segoe UI", Tahoma, Verdana, sans-serif;
  color: #e5e7eb;
}

/* ======================================================
   LED STATUS DOT
====================================================== */

.led {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 8px;
  vertical-align: middle;
}

/* MODR√Å ‚Äì informaƒçn√≠ / stavov√° */
.led-blue {
  background: #38bdf8;
  box-shadow:
    0 0 6px rgba(56,189,248,0.8),
    0 0 12px rgba(56,189,248,0.6);
}

/* ƒåERVEN√Å ‚Äì rozhodnut√≠ / odpovƒõdnost */
.led-red {
  background: #ef4444;
  box-shadow:
    0 0 6px rgba(239,68,68,0.8),
    0 0 12px rgba(239,68,68,0.6);
}

/* ZLAT√Å ‚Äì audit / uzav≈ôen√≠ / autorita */
.led-gold {
  background: #facc15;
  box-shadow:
    0 0 6px rgba(250,204,21,0.8),
    0 0 12px rgba(250,204,21,0.6);
}
/* ======================================================
   ROZHODNUT√ç DRU≈ΩSTVA ‚Äì FIN√ÅLN√ç ZAROVN√ÅN√ç
====================================================== */

.decision-form {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  max-width: 520px;   /* üîí sjednocen√≠ ≈°√≠≈ôky */
}

.decision-form label {
  font-size: 13px;
  color: #9ca3af;
}

.decision-form select,
.decision-form textarea {
  width: 100%;
  background: #020617;
  border: 1px solid rgba(148,163,184,.25);
  border-radius: 10px;
  padding: 10px;
  color: #e5e7eb;
  font-family: inherit;
}

.decision-form textarea {
  min-height: 90px;
  resize: vertical;
}

/* TLAƒå√çTKO ‚Äì STEJN√Å OSA JAKO TEXTAREA */
.decision-submit {
  align-self: flex-end;   /* üîë */
  margin-top: 6px;
}


</style>
</head>

<body>
<div id="user-bar" style="
  position:fixed;
  top:12px;
  right:16px;
  z-index:9999;
  font-size:12px;
  color:#e5e7eb;
  background:rgba(2,6,23,0.85);
  border:1px solid rgba(148,163,184,0.3);
  padding:6px 12px;
  border-radius:999px;
  display:none;
">
  P≈ôihl√°≈°en: <span id="user-email"></span>
  ¬∑ <a href="#" id="logout" style="color:#4fa3ff;text-decoration:none;">Odhl√°sit</a>
</div>

<div class="page">

<!-- ======================================================
   1Ô∏è‚É£ ƒåLENSK√Å KARTA ‚Äì INTERN√ç V√ùJEZD
====================================================== -->
<section class="panel">
  <div class="section-head">
    <span class="led led-gold"></span>
    ƒålensk√° karta ‚Äì intern√≠ v√Ωjezd
  </div>

  <p>Autoritativn√≠ intern√≠ v√Ωstup syst√©mu. Nen√°rokov√©.</p>

  <div class="grid-2" style="margin-top:20px">
    <div>
      <label>Email ƒçlena</label>
      <input class="input" placeholder="clen@winwin.cz">
      <div style="margin-top:12px;display:flex;gap:12px">
        <button class="btn" onclick="loadMember()">
  Naƒç√≠st ƒçlena
</button>

<button class="btn" onclick="openMemberPdf()">
  Export PDF
</button>

    </div>

    <div class="panel">
  <b>V√Ωstup ƒçlena</b><br>
  <span style="color:var(--muted)">
    Identita ¬∑ Anga≈æovanost ¬∑ SPF ¬∑ Role ¬∑ Matching
  </span>

  <hr style="margin:12px 0;opacity:.4">

  <div style="font-size:13px;line-height:1.6">
    <div><b>Jm√©no:</b> <span id="mi-name">‚Äî</span></div>
    <div><b>Email:</b> <span id="mi-email">‚Äî</span></div>
    <div><b>Stav:</b> <span id="mi-status">‚Äî</span></div>
    <div><b>ID ƒçlena:</b> <span id="mi-id">‚Äî</span></div>
    <div><b>Registrace:</b> <span id="mi-created">‚Äî</span></div>
  </div>
</div>

  </div>
</section>

<!-- ======================================================
   KARI√âRN√ç ODPOVƒöDNOST A SCHVALOV√ÅN√ç POZICE ƒåLENA
====================================================== -->
<section class="panel">

  <div class="section-head">
    <span class="led led-blue"></span>
    Kari√©rn√≠ odpovƒõdnost a schvalov√°n√≠ pozice ƒçlena
  </div>

  <p class="muted">
    Intern√≠ schvalovac√≠ r√°mec dru≈æstva WIN.WIN.
    Uveden√© hodnoty p≈ôedstavuj√≠ maxim√°ln√≠ matching bonus vypl√Ωvaj√≠c√≠
    z potvrzen√© kari√©rn√≠ pozice a struktury s√≠tƒõ ƒçlena.
  </p>

  <!-- ===============================
     HLAVN√ç KARTA
  ============================== -->
  <div class="card" id="career-approval-box">

    <!-- ===== SOUHRN S√çTƒö ===== -->
    <div class="subcard">
      <div class="subcard-head">
        <span class="led led-blue"></span>
        Souhrn s√≠tƒõ ƒçlena
      </div>

      <table>
        <tbody>
          <tr>
            <td>P≈ô√≠m√≠ pod≈ô√≠zen√≠</td>
            <td id="net-direct">‚Äî</td>
          </tr>
          <tr>
            <td>Aktivn√≠ t√Ωm (celkem)</td>
            <td id="net-total">‚Äî</td>
          </tr>
          <tr>
            <td>Maxim√°ln√≠ hloubka struktury</td>
            <td id="net-depth">‚Äî</td>
          </tr>
          <tr>
            <td>Orientaƒçn√≠ n√°vrh pozice (nez√°vazn√©)</td>
            <td id="net-suggested-role">‚Äî</td>
          </tr>
        </tbody>
      </table>
    </div>

<div class="card">
  <h3>V√Ωbƒõr ƒçlena</h3>

  <select id="member-select" style="width:100%;padding:8px">
    <option value="">‚Äî vyber ƒçlena ‚Äî</option>
  </select>
</div>


    <!-- ===== AKTU√ÅLN√ç KARI√âRN√ç STAV ===== -->
    <div class="subcard">
      <div class="subcard-head">
        <span class="led led-blue"></span>
        Aktu√°ln√≠ kari√©rn√≠ pozice
      </div>

      <table>
        <tbody>
          <tr>
            <td>Pozice</td>
            <td id="career-current-role">‚Äî</td>
          </tr>
          <tr>
            <td>Platn√° od</td>
            <td id="career-valid-from">‚Äî</td>
          </tr>
          <tr>
            <td>Schv√°leno k√Ωm</td>
            <td id="career-approved-by">‚Äî</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ===== ROZHODNUT√ç DRU≈ΩSTVA ===== -->
 <div class="subcard admin-only">
  <h4>
    <span class="led led-red"></span>
    Rozhodnut√≠ dru≈æstva
  </h4>

  <div class="decision-form">

    <label for="career-role-select">
      Schv√°lit kari√©rn√≠ pozici
    </label>
    <select id="career-role-select">
      <option value="">‚Äî vybrat pozici ‚Äî</option>
    </select>

    <label for="career-decision-note">
      Od≈Øvodnƒõn√≠ rozhodnut√≠ (povinn√©)
    </label>

    <textarea
      id="career-decision-note"
      placeholder="Od≈Øvodnƒõn√≠ rozhodnut√≠ dru≈æstva‚Ä¶">
    </textarea>

    <button class="btn-primary decision-submit"
            onclick="approveCareerRole()">
      Schv√°lit kari√©rn√≠ pozici
    </button>

  </div>
</div>

</section>

<!-- ======================================================
   3Ô∏è‚É£ OBCHODN√çCI / AGENTS ‚Äì KARI√âRN√ç REGISTRACE
====================================================== -->
<section class="panel agents-panel">
  <div class="section-head">
    <span class="led led-teal"></span>
    Obchodn√≠ci / Agents ‚Äì kari√©rn√≠ registrace
  </div>

  <p>
    Zde se vytv√°≈ô√≠ dlouhodob√° kari√©rn√≠ identita obchodn√≠ka.
    Promo k√≥dy a provize se spravuj√≠ v admin sekci.
  </p>

  <!-- REGISTRACE -->
  <div class="panel" style="margin-top:16px">
    <b>Registrace obchodn√≠ka (kari√©rn√≠ vstup)</b>

    <div class="grid-3" style="margin-top:12px">
      <input class="input" placeholder="Jm√©no">
      <input class="input" placeholder="Email">
      <select>
        <option value="">Vyber kari√©rn√≠ roli</option>
        <option>T</option><option>T1</option><option>T2</option><option>T3</option>
        <option>M</option><option>M1</option><option>M2</option><option>M3</option>
        <option>TM</option><option>TM1</option><option>TM2</option><option>TM3</option><option>TM4</option>
        <option>TL</option><option>TL1</option><option>TL2</option>
        <option>VP</option><option>P</option>
      </select>
    </div>
<button
  class="btn"
  style="margin-top:12px"
  onclick="registerAgent()">
  Zapsat obchodn√≠ka
</button>

  <!-- SEZNAM -->
  <b style="display:block;margin-top:24px">Obchodn√≠ci (p≈ôehled)</b>

  <table style="margin-top:8px">
    <thead>
      <tr>
        <th>ID</th>
        <th>Jm√©no</th>
        <th>Email</th>
        <th>Kari√©rn√≠ role</th>
        <th>Promo k√≥dy</th>
      </tr>
    </thead>
    <tbody id="agents-career-body">
  <tr>
    <td colspan="5">Naƒç√≠t√°m obchodn√≠ky‚Ä¶</td>
  </tr>
</tbody>

  </table>
<button class="btn" onclick="openAgentsPdf()">
  PDF ‚Äì evidence obchodn√≠k≈Ø
</button>

</section>

</div>

<!-- ======================================================
     SUPABASE KLIENT
====================================================== -->
<script type="module">
import { createClient } from
  "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

window.supabase = createClient(
  "https://azfrniqqtetoqploxwgq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU"
);
</script>

<script>
/* =========================================
   REGISTRACE OBCHODN√çKA (JEDIN√Å VERZE)
========================================= */
async function registerAgent() {

  const name = document.querySelector(
    "input[placeholder='Jm√©no']"
  )?.value.trim();

  const email = document.querySelector(
    "input[placeholder='Email']"
  )?.value.trim();

  const role = document.querySelector("select")?.value;

  if (!name || !email || !role) {
    alert("Vypl≈à jm√©no, e-mail a kari√©rn√≠ roli.");
    return;
  }

  // üîí zat√≠m jen UI + log (DB p≈ôipoj√≠me pozdƒõji)
  console.log("REGISTRACE OBCHODN√çKA:", {
    name, email, role
  });

  alert(
    "Obchodn√≠k je p≈ôipraven k z√°pisu.\n" +
    "Dal≈°√≠ krok: INSERT do DB."
  );
}

/* =========================================
   PDF ‚Äì EVIDENCE OBCHODN√çK≈Æ
========================================= */
function openAgentsPdf() {
  window.open(
    "/agents-career-pdf.html?v=20260115",
    "_blank"
  );
}


/* =========================================
   NAƒåTEN√ç ƒåLENA ‚Äì MEMBER INTELLIGENCE
========================================= */
async function loadMember() {

  const emailInput = document.querySelector(
    "input[placeholder='clen@winwin.cz']"
  );

  if (!emailInput || !emailInput.value) {
    alert("Zadej e-mail ƒçlena.");
    return;
  }

  const email = emailInput.value.trim().toLowerCase();

  const { data, error } = await window.supabase
    .from("members_data")
    .select("*")
    .eq("email", email)
    .single();

  if (error || !data) {
    console.error(error);
    alert("ƒålen nebyl nalezen.");
    return;
  }

  document.getElementById("mi-name").textContent =
    data.full_name || data.name || "‚Äî";

  document.getElementById("mi-email").textContent =
    data.email;

  document.getElementById("mi-status").textContent =
    data.status || "‚Äî";

  document.getElementById("mi-id").textContent =
    data.id ?? "‚Äî";

  document.getElementById("mi-created").textContent =
    data.created_at
      ? new Date(data.created_at).toLocaleString("cs-CZ")
      : "‚Äî";
}

/* =========================================
   EXPORT PDF ‚Äì ƒåLENSK√Å KARTA (S EMAIL)
========================================= */
function openMemberPdf() {

  const emailInput = document.querySelector(
    "input[placeholder='clen@winwin.cz']"
  );

  if (!emailInput || !emailInput.value) {
    alert("Nejprve naƒçti ƒçlena.");
    return;
  }

  const email = emailInput.value.trim().toLowerCase();

  window.open(
    "member-card-pdf.html?email=" +
      encodeURIComponent(email),
    "_blank"
  );
}
</script>
<script>
async function registerAgent() {

  const nameInput = document.querySelector("input[placeholder='Jm√©no']");
  const emailInput = document.querySelector("input[placeholder='Email']");
  const roleSelect = document.querySelector("select");

  if (!nameInput || !emailInput || !roleSelect) {
    alert("Formul√°≈ô nen√≠ kompletn√≠.");
    return;
  }

  const name = nameInput.value.trim();
  const email = emailInput.value.trim().toLowerCase();
  const roleCode = roleSelect.value;

  if (!name || !email || !roleCode) {
    alert("Vypl≈à jm√©no, e-mail a kari√©rn√≠ roli.");
    return;
  }

  /* 1Ô∏è‚É£ najdeme ƒçlena */
  const { data: member, error: memberError } = await window.supabase
    .from("members_data")
    .select("id")
    .eq("email", email)
    .single();

  if (memberError || !member) {
    alert("ƒålen s t√≠mto e-mailem neexistuje.");
    return;
  }

  /* 2Ô∏è‚É£ najdeme kari√©rn√≠ roli */
  const { data: role, error: roleError } = await window.supabase
    .from("career_roles")
    .select("id")
    .eq("code", roleCode)
    .single();

  if (roleError || !role) {
    alert("Neplatn√° kari√©rn√≠ role.");
    return;
  }

  /* 3Ô∏è‚É£ deaktivujeme star√© role */
await window.supabase
  .from("member_career")
  .update({ status: "revoked" })
  .eq("member_id", member.id)
  .eq("status", "active");

/* 4Ô∏è‚É£ zap√≠≈°eme novou kari√©ru */
const { error: insertError } = await window.supabase
  .from("member_career")
  .insert({
    member_id: member.id,
    role_id: role.id,
    status: "active",
    assigned_by: "admin",
    note: "Kari√©rn√≠ registrace ‚Äì intern√≠ rozhodnut√≠"
  });


  if (insertError) {
    console.error(insertError);
    alert("Chyba p≈ôi z√°pisu kari√©ry.");
    return;
  }

  alert("‚úÖ Obchodn√≠k byl √∫spƒõ≈°nƒõ zaregistrov√°n.");

  nameInput.value = "";
  emailInput.value = "";
  roleSelect.value = "";
}
</script>

<script>
async function loadAgentsCareer() {

  const tbody = document.getElementById("agents-career-body");
  if (!tbody) return;

  tbody.innerHTML =
    `<tr><td colspan="5">Naƒç√≠t√°m obchodn√≠ky‚Ä¶</td></tr>`;

  const { data, error } = await window.supabase
    .from("member_career")
    .select(`
      id,
      assigned_at,
      members_data (
        full_name,
        email
      ),
      career_roles (
        code,
        name
      )
    `)
    .eq("status", "active");

  if (error) {
    console.error("Chyba p≈ôi naƒç√≠t√°n√≠ kari√©ry:", error);
    tbody.innerHTML =
      `<tr><td colspan="5">Chyba naƒçten√≠ kari√©ry</td></tr>`;
    return;
  }

  if (!data || data.length === 0) {
    tbody.innerHTML =
      `<tr><td colspan="5">≈Ω√°dn√≠ obchodn√≠ci nejsou evidov√°ni.</td></tr>`;
    return;
  }

  tbody.innerHTML = "";

  data.forEach(row => {

    const name = row.members_data?.full_name ?? "‚Äî";
    const email = row.members_data?.email ?? "‚Äî";
    const role =
      row.career_roles
        ? `${row.career_roles.code} ‚Äì ${row.career_roles.name}`
        : "‚Äî";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${name}</td>
      <td>${email}</td>
      <td>${role}</td>
      <td>‚Äî</td>
    `;

    tbody.appendChild(tr);
  });
}

/* automatick√© naƒçten√≠ po otev≈ôen√≠ str√°nky */
document.addEventListener("DOMContentLoaded", loadAgentsCareer);
</script>

<script type="module">
import { createClient } from
  "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ===============================
   SUPABASE
================================ */
const supabase = createClient(
  "https://azfrniqqtetoqploxwgq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6ZnJuaXFxdGV0b3FwbG94d2dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzQ1OTYsImV4cCI6MjA4MzMxMDU5Nn0.QchmzNhs8owd6pkjZCk04u6PJoJ2Bhzz7oGV0KFyqdU"
);

window.supabase = supabase;

let currentMemberId = null;

/* ===============================
   LOAD CAREER ROLES (REFERENCE)
================================ */
async function loadCareerRoles() {
  const { data, error } = await supabase
    .from("career_roles")
    .select("code, name, max_matching_percent")
    .eq("is_active", true)
    .order("max_matching_percent");

  const select = document.getElementById("career-role-select");
  select.innerHTML = `<option value="">‚Äî vybrat pozici ‚Äî</option>`;

  if (error || !data) return;

  data.forEach(r => {
    select.insertAdjacentHTML(
      "beforeend",
      `<option value="${r.code}">
        ${r.code} ‚Äì ${r.name} (${r.max_matching_percent}%)
      </option>`
    );
  });
}

/* ===============================
   LOAD MEMBER SUMMARY
================================ */
async function loadMemberCareerSummary(memberId) {
  currentMemberId = memberId;

  /* --- S√ç≈§ (ZAT√çM JEDNODUCH√â) --- */
  const { data: net } = await supabase
    .from("member_network")
    .select("member_id")
    .eq("parent_member_id", memberId);

  document.getElementById("net-direct").innerText =
    net?.length ?? "0";

  document.getElementById("net-total").innerText =
    net?.length ?? "0";

  document.getElementById("net-depth").innerText =
    net?.length ? "1+" : "0";

  document.getElementById("net-suggested-role").innerText =
    "‚Äî";

  /* --- AKTU√ÅLN√ç KARI√âRA --- */
  const { data: career } = await supabase
    .from("member_career_history")
    .select("career_level, valid_from, approved_by")
    .eq("member_id", memberId)
    .order("valid_from", { ascending: false })
    .limit(1);

  if (career && career.length) {
    const c = career[0];

    document.getElementById("career-current-role").innerText =
      c.career_level ?? "‚Äî";

    document.getElementById("career-valid-from").innerText =
      c.valid_from
        ? new Date(c.valid_from).toLocaleDateString()
        : "‚Äî";

    document.getElementById("career-approved-by").innerText =
      c.approved_by ?? "‚Äî";
  } else {
    document.getElementById("career-current-role").innerText = "‚Äî";
    document.getElementById("career-valid-from").innerText = "‚Äî";
    document.getElementById("career-approved-by").innerText = "‚Äî";
  }
}

/* ===============================
   LOAD MEMBERS LIST
================================ */
async function loadMembersList() {
  const { data, error } = await supabase
    .from("members_data")
    .select("id, email, full_name")
    .order("id");

  if (error || !data) {
    console.error(error);
    return;
  }

  const select = document.getElementById("member-select");
  select.innerHTML = `<option value="">‚Äî vyber ƒçlena ‚Äî</option>`;

  data.forEach(m => {
    select.insertAdjacentHTML(
      "beforeend",
      `<option value="${m.id}">
        ${m.full_name ?? m.email} (ID ${m.id})
      </option>`
    );
  });
}

/* ===============================
   APPROVE CAREER ROLE
================================ */
window.approveCareerRole = async () => {

  if (!currentMemberId) {
    alert("Nejprve naƒçti ƒçlena.");
    return;
  }

  const careerLevel =
    document.getElementById("career-role-select").value;

  const note =
    document.getElementById("career-decision-note").value.trim();

  if (!careerLevel) {
    alert("Vyber kari√©rn√≠ pozici.");
    return;
  }

  if (!note) {
    alert("Od≈Øvodnƒõn√≠ je povinn√©.");
    return;
  }

  if (!confirm(
    "Schv√°lit kari√©rn√≠ pozici?\nRozhodnut√≠ bude auditnƒõ zaznamen√°no."
  )) return;

  const session = (await supabase.auth.getSession()).data.session;
  if (!session) {
    alert("Nejste p≈ôihl√°≈°en.");
    return;
  }

  const { error } = await supabase
    .from("member_career_history")
    .insert({
      member_id: currentMemberId,
      career_level: careerLevel,
      valid_from: new Date().toISOString().slice(0,10),
      approved_by: session.user.id,
      note: note,
      source: "member-intelligence"
    });

  if (error) {
    alert("Chyba p≈ôi schv√°len√≠ pozice.");
    console.error(error);
    return;
  }

  alert("Kari√©rn√≠ pozice byla schv√°lena.");
  loadMemberCareerSummary(currentMemberId);
};

/* ===============================
   INIT
================================ */
document.addEventListener("DOMContentLoaded", () => {

  loadMembersList();
  loadCareerRoles();

  const memberSelect =
    document.getElementById("member-select");

  if (memberSelect) {
    memberSelect.addEventListener("change", e => {
      const memberId = e.target.value;
      if (memberId) {
        loadMemberCareerSummary(Number(memberId));
      }
    });
  }

});
</script>


</body>
</html>
